<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>react æºç  | theydy</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/notebook/icon.png">
    <meta name="description" content="è¯»ä¹¦ç¬”è®° + çŸ¥è¯†æ•´ç†">
    
    <link rel="preload" href="/notebook/assets/css/0.styles.254e6a27.css" as="style"><link rel="preload" href="/notebook/assets/js/app.15aa8661.js" as="script"><link rel="preload" href="/notebook/assets/js/2.b500958f.js" as="script"><link rel="preload" href="/notebook/assets/js/31.966a99c6.js" as="script"><link rel="prefetch" href="/notebook/assets/js/10.c3ab5cb6.js"><link rel="prefetch" href="/notebook/assets/js/11.1a408ed4.js"><link rel="prefetch" href="/notebook/assets/js/12.96ace62a.js"><link rel="prefetch" href="/notebook/assets/js/13.564cae12.js"><link rel="prefetch" href="/notebook/assets/js/14.3eaa783e.js"><link rel="prefetch" href="/notebook/assets/js/15.f1f3cc2e.js"><link rel="prefetch" href="/notebook/assets/js/16.9b778b21.js"><link rel="prefetch" href="/notebook/assets/js/17.ae11984e.js"><link rel="prefetch" href="/notebook/assets/js/18.4f83f6eb.js"><link rel="prefetch" href="/notebook/assets/js/19.81ff8ebe.js"><link rel="prefetch" href="/notebook/assets/js/20.de065017.js"><link rel="prefetch" href="/notebook/assets/js/21.4fae332a.js"><link rel="prefetch" href="/notebook/assets/js/22.76159f4a.js"><link rel="prefetch" href="/notebook/assets/js/23.18d00419.js"><link rel="prefetch" href="/notebook/assets/js/24.8676fad5.js"><link rel="prefetch" href="/notebook/assets/js/25.cdd52113.js"><link rel="prefetch" href="/notebook/assets/js/26.a4e1407a.js"><link rel="prefetch" href="/notebook/assets/js/27.5ea7889c.js"><link rel="prefetch" href="/notebook/assets/js/28.4f452941.js"><link rel="prefetch" href="/notebook/assets/js/29.4445e879.js"><link rel="prefetch" href="/notebook/assets/js/3.6e482d8e.js"><link rel="prefetch" href="/notebook/assets/js/30.5dbfe8c9.js"><link rel="prefetch" href="/notebook/assets/js/32.65399fb3.js"><link rel="prefetch" href="/notebook/assets/js/33.517cd9f7.js"><link rel="prefetch" href="/notebook/assets/js/34.7650cb4f.js"><link rel="prefetch" href="/notebook/assets/js/35.8cb6535a.js"><link rel="prefetch" href="/notebook/assets/js/36.e4cea6a9.js"><link rel="prefetch" href="/notebook/assets/js/37.65ab33d6.js"><link rel="prefetch" href="/notebook/assets/js/38.f8d83db7.js"><link rel="prefetch" href="/notebook/assets/js/4.779e3c9b.js"><link rel="prefetch" href="/notebook/assets/js/5.5b45f7ce.js"><link rel="prefetch" href="/notebook/assets/js/6.4bc4ed52.js"><link rel="prefetch" href="/notebook/assets/js/7.22950914.js"><link rel="prefetch" href="/notebook/assets/js/8.edafac0c.js"><link rel="prefetch" href="/notebook/assets/js/9.64de7391.js">
    <link rel="stylesheet" href="/notebook/assets/css/0.styles.254e6a27.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notebook/" class="home-link router-link-active"><!----> <span class="site-name">theydy</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/notebook/interview/js.html" class="nav-link">
  å‰ç«¯é¢è¯•
</a></div><div class="nav-item"><a href="/notebook/vue/analysis.html" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/notebook/react/setup.html" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/notebook/webpack/4.html" class="nav-link">
  Webpack
</a></div><div class="nav-item"><a href="/notebook/other/tools.html" class="nav-link">
  æ‚ä¸ƒæ‚å…«
</a></div><div class="nav-item"><a href="/notebook/engineering/package-json.html" class="nav-link">
  å·¥ç¨‹åŒ–
</a></div> <a href="https://github.com/theydy/notebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/notebook/interview/js.html" class="nav-link">
  å‰ç«¯é¢è¯•
</a></div><div class="nav-item"><a href="/notebook/vue/analysis.html" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/notebook/react/setup.html" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/notebook/webpack/4.html" class="nav-link">
  Webpack
</a></div><div class="nav-item"><a href="/notebook/other/tools.html" class="nav-link">
  æ‚ä¸ƒæ‚å…«
</a></div><div class="nav-item"><a href="/notebook/engineering/package-json.html" class="nav-link">
  å·¥ç¨‹åŒ–
</a></div> <a href="https://github.com/theydy/notebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>react</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notebook/react/setup.html" class="sidebar-link">react</a></li><li><a href="/notebook/react/analysis.html" aria-current="page" class="active sidebar-link">react æºç </a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notebook/react/analysis.html#fiber-æ¶æ„" class="sidebar-link">Fiber æ¶æ„</a></li><li class="sidebar-sub-header"><a href="/notebook/react/analysis.html#jsx" class="sidebar-link">JSX</a></li><li class="sidebar-sub-header"><a href="/notebook/react/analysis.html#render-é˜¶æ®µ" class="sidebar-link">render é˜¶æ®µ</a></li><li class="sidebar-sub-header"><a href="/notebook/react/analysis.html#commit-é˜¶æ®µ" class="sidebar-link">commit é˜¶æ®µ</a></li><li class="sidebar-sub-header"><a href="/notebook/react/analysis.html#diff-ç®—æ³•" class="sidebar-link">diff ç®—æ³•</a></li><li class="sidebar-sub-header"><a href="/notebook/react/analysis.html#çŠ¶æ€æ›´æ–°æœºåˆ¶" class="sidebar-link">çŠ¶æ€æ›´æ–°æœºåˆ¶</a></li><li class="sidebar-sub-header"><a href="/notebook/react/analysis.html#æç®€-hooks-çš„å®ç°" class="sidebar-link">æç®€ hooks çš„å®ç°</a></li><li class="sidebar-sub-header"><a href="/notebook/react/analysis.html#build-your-own-react" class="sidebar-link">build your own react</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="react-æºç "><a href="#react-æºç " class="header-anchor">#</a> react æºç </h1> <h2 id="fiber-æ¶æ„"><a href="#fiber-æ¶æ„" class="header-anchor">#</a> Fiber æ¶æ„</h2> <p>Fiber æ¶æ„</p> <ul><li>Scheduler è°ƒåº¦å™¨</li> <li>Reconciler åè°ƒå™¨</li> <li>Renderer æ¸²æŸ“å™¨</li></ul> <p>Fiber ä¹Ÿå«â€œçº¤ç¨‹â€ï¼Œæ˜¯ä¸€ç§å¼‚æ­¥å¯ä¸­æ–­çš„å®ç°ã€‚ä»–å®ç°äº†ä¸¤ä¸ªç›®æ ‡ã€‚</p> <ul><li>æ›´æ–°å¯ä»¥ä¸­æ–­å¹¶ç»§ç»­</li> <li>æ›´æ–°å¯ä»¥æ‹¥æœ‰ä¸åŒçš„ä¼˜å…ˆçº§ï¼Œé«˜ä¼˜å…ˆçº§æ›´æ–°å¯ä»¥æ‰“æ–­ä½ä¼˜å…ˆçº§çš„æ›´æ–°</li></ul> <h3 id="å·¥ä½œåŸç†"><a href="#å·¥ä½œåŸç†" class="header-anchor">#</a> å·¥ä½œåŸç†</h3> <p>ä½œä¸ºé™æ€çš„æ•°æ®ç»“æ„æ¥è¯´æ¯ä¸ª Fiber èŠ‚ç‚¹å¯¹åº”ä¸€ä¸ª React elementï¼Œä¿å­˜äº†è¯¥ç»„ä»¶çš„ç±»å‹ï¼ˆå‡½æ•°ç»„ä»¶/ç±»ç»„ä»¶/åŸç”Ÿç»„ä»¶...ï¼‰ã€å¯¹åº”çš„DOMèŠ‚ç‚¹ç­‰ä¿¡æ¯ã€‚</p> <p>ä½œä¸ºåŠ¨æ€çš„å·¥ä½œå•å…ƒæ¥è¯´æ¯ä¸ª Fiber èŠ‚ç‚¹ä¿å­˜äº†æœ¬æ¬¡æ›´æ–°ä¸­è¯¥ç»„ä»¶æ”¹å˜çš„çŠ¶æ€ã€è¦æ‰§è¡Œçš„å·¥ä½œï¼ˆéœ€è¦è¢«åˆ é™¤/è¢«æ’å…¥é¡µé¢ä¸­/è¢«æ›´æ–°...ï¼‰ã€‚</p> <p>Fiber ä½¿ç”¨ä¸€ç§è¢«å«åš<strong>åŒç¼“å­˜</strong>çš„æœºåˆ¶ã€‚</p> <p>Fiber èŠ‚ç‚¹ä¸­æœ‰ä¸ª alternate å±æ€§æŒ‡å‘å¦ä¸€æ¬¡æ›´æ–°æ—¶å¯¹åº”çš„ Fiberï¼Œåˆ†åˆ«æ˜¯ current Fiber æ ‘å’Œ workInProgress Fiber æ ‘ã€‚
å½“ workInProgress Fiber æ ‘å®Œæˆäº†æ¸²æŸ“ï¼ŒFiberRootNode å°±æŒ‡å‘äº† workInProgress Fiber æ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œ
æ­¤æ—¶ workInProgress Fiber æ ‘å°±å˜æˆäº† current Fiber æ ‘ã€‚
ä¸‹æ¬¡è§¦å‘æ›´æ–°æ—¶åˆåˆ›å»ºä¸€æ£µæ–°çš„ workInProgress Fiber æ ‘ã€‚workInProgress Fiber æ ‘çš„èŠ‚ç‚¹æ˜¯æ ¹æ® current Fiber æ ‘çš„èŠ‚ç‚¹åˆ›å»ºçš„ã€‚
æ ¹æ® current Fiber ä¸æœ¬æ¬¡æ›´æ–°è¿”å›çš„ JSX ç»“æ„åšå¯¹æ¯”ç”Ÿæˆ workInProgress Fiber æ ‘çš„è¿‡ç¨‹å°±æ˜¯ diff ç®—æ³•ã€‚</p> <h2 id="jsx"><a href="#jsx" class="header-anchor">#</a> JSX</h2> <p>JSX å…¶å®å°±æ˜¯ React.createElement çš„è¯­æ³•ç³–ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>div title<span class="token operator">=</span><span class="token string">'1'</span><span class="token operator">&gt;</span><span class="token number">111</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>

<span class="token comment">// transform to React.createElement</span>
React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  title<span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'111'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token operator">&lt;</span>div title<span class="token operator">=</span><span class="token string">'1'</span><span class="token operator">&gt;</span><span class="token number">111</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token comment">// transform to React.createElement</span>
React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>Foo<span class="token punctuation">)</span>
</code></pre></div><p>React.createElement æœ€åè¿”å›çš„æ˜¯ React.Element å¯¹è±¡ã€‚</p> <p>React.Element å¯¹è±¡çš„ç»“æ„ä¸º</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// This tag allows us to uniquely identify this as a React Element</span>
    $$<span class="token keyword">typeof</span><span class="token operator">:</span> <span class="token constant">REACT_ELEMENT_TYPE</span><span class="token punctuation">,</span>

    <span class="token comment">// Built-in properties that belong on the element</span>
    type<span class="token operator">:</span> type<span class="token punctuation">,</span>
    key<span class="token operator">:</span> key<span class="token punctuation">,</span>
    ref<span class="token operator">:</span> ref<span class="token punctuation">,</span>
    props<span class="token operator">:</span> props<span class="token punctuation">,</span>

    <span class="token comment">// Record the component responsible for creating this element.</span>
    _owner<span class="token operator">:</span> owner<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="render-é˜¶æ®µ"><a href="#render-é˜¶æ®µ" class="header-anchor">#</a> render é˜¶æ®µ</h2> <p>render é˜¶æ®µçš„å…¥å£æ˜¯ <code>performSyncWorkOnRoot</code> æˆ– <code>performConcurrentWorkOnRoot</code></p> <p>render ä½¿ç”¨éå†æ¥å®ç°å¯ä¸­æ–­çš„é€’å½’ã€‚é¦–æ¬¡æ¸²æŸ“å’Œéé¦–æ¬¡æ¸²æŸ“èµ°çš„è¿‡ç¨‹ä¸åŒï¼Œæ‰€ä»¥åˆ†ä¸ºä¸¤ç§æƒ…å†µæ¥è¯´ï¼Œæ¯ç§æƒ…å†µåˆå¯è¯¦ç»†åˆ†ä¸ºâ€œé€’â€é˜¶æ®µå’Œâ€œå½’â€é˜¶æ®µã€‚</p> <h3 id="é¦–æ¬¡æ¸²æŸ“-mount-é˜¶æ®µ"><a href="#é¦–æ¬¡æ¸²æŸ“-mount-é˜¶æ®µ" class="header-anchor">#</a> é¦–æ¬¡æ¸²æŸ“ mount é˜¶æ®µ</h3> <p>é¦–æ¬¡æ¸²æŸ“ mount æ—¶æ²¡æœ‰ current Fiber æ ‘ã€‚</p> <p><strong>â€œé€’â€é˜¶æ®µ</strong></p> <p>æ­¤æ—¶ä¼šä» rootFiber å¼€å§‹é€šè¿‡æ·±åº¦ä¼˜å…ˆéå†ï¼Œéå†æ¯ä¸ª Fiber èŠ‚ç‚¹è°ƒç”¨ beginWork æ–¹æ³•ã€‚</p> <p>è¯¥æ–¹æ³•ä¼šæ ¹æ®ä¼ å…¥çš„ Fiber èŠ‚ç‚¹åˆ›å»ºå­ Fiber èŠ‚ç‚¹ï¼ˆreconcileChildren å‡½æ•°ï¼‰ï¼Œå¹¶å°†è¿™ä¸¤ä¸ª Fiber èŠ‚ç‚¹è¿æ¥èµ·æ¥ã€‚</p> <p>å½“éå†åˆ°å¶å­èŠ‚ç‚¹ï¼ˆå³æ²¡æœ‰å­ç»„ä»¶çš„ç»„ä»¶ï¼‰æ—¶å°±ä¼šè¿›å…¥â€œå½’â€é˜¶æ®µã€‚</p> <p><strong>â€œå½’â€é˜¶æ®µ</strong></p> <p>åœ¨â€œå½’â€é˜¶æ®µä¼šè°ƒç”¨ completeWork å¤„ç† Fiber èŠ‚ç‚¹ã€‚</p> <p>å½“æŸä¸ª Fiber èŠ‚ç‚¹æ‰§è¡Œå®Œ completeWorkï¼Œå¦‚æœå…¶å­˜åœ¨å…„å¼Ÿ Fiber èŠ‚ç‚¹ï¼ˆå³ fiber.sibling !== nullï¼‰ï¼Œä¼šè¿›å…¥å…¶å…„å¼Ÿ Fiber çš„â€œé€’â€é˜¶æ®µã€‚</p> <p>å¦‚æœä¸å­˜åœ¨å…„å¼Ÿ Fiberï¼Œä¼šè¿›å…¥çˆ¶çº§ Fiber çš„â€œå½’â€é˜¶æ®µã€‚</p> <p>â€œé€’â€å’Œâ€œå½’â€é˜¶æ®µä¼šäº¤é”™æ‰§è¡Œç›´åˆ°â€œå½’â€åˆ° rootFiberã€‚è‡³æ­¤ï¼Œrender é˜¶æ®µçš„å·¥ä½œå°±ç»“æŸäº†ã€‚</p> <p>ğŸŒ°</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
      i am
      <span class="token operator">&lt;</span>span<span class="token operator">&gt;</span>xxx<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// render é˜¶æ®µä¼šä¾æ¬¡æ‰§è¡Œï¼š</span>
<span class="token comment">// 1. rootFiber beginWork</span>
<span class="token comment">// 2. App Fiber beginWork</span>
<span class="token comment">// 3. div Fiber beginWork</span>
<span class="token comment">// 4. &quot;i am&quot; Fiber beginWork</span>
<span class="token comment">// 5. &quot;i am&quot; Fiber completeWork</span>
<span class="token comment">// 6. span Fiber beginWork</span>
<span class="token comment">// 7. span Fiber completeWork</span>
<span class="token comment">// 8. div Fiber completeWork</span>
<span class="token comment">// 9. App Fiber completeWork</span>
<span class="token comment">// 10. rootFiber completeWork</span>
<span class="token comment">// ä¹‹æ‰€ä»¥æ²¡æœ‰ &quot;xxx&quot; Fiber çš„ beginWork/completeWorkï¼Œ</span>
<span class="token comment">// æ˜¯å› ä¸ºä½œä¸ºä¸€ç§æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µï¼Œé’ˆå¯¹åªæœ‰å•ä¸€æ–‡æœ¬å­èŠ‚ç‚¹çš„ Fiberï¼ŒReact ä¼šç‰¹æ®Šå¤„ç†ã€‚</span>
</code></pre></div><h3 id="beginwork-å…·ä½“åšä»€ä¹ˆ"><a href="#beginwork-å…·ä½“åšä»€ä¹ˆ" class="header-anchor">#</a> beginWork å…·ä½“åšä»€ä¹ˆ</h3> <p>beginWork è¿›å…¥åé¦–å…ˆåˆ¤æ–­æ˜¯å¦æœ‰ currentï¼Œå¦‚æœæœ‰è¯´æ˜æ˜¯ update èŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æœ‰è¯´æ˜æ˜¯ mount é˜¶æ®µï¼Œè¿™é‡Œé¦–æ¬¡æ¸²æŸ“å’Œéé¦–æ¬¡æ¸²æŸ“æ‰§è¡Œäº†ä¸€äº›ä¸åŒçš„æ“ä½œã€‚</p> <ul><li>update æ—¶ï¼šå¦‚æœ current å­˜åœ¨ï¼Œåœ¨æ»¡è¶³ä¸€å®šæ¡ä»¶æ—¶å¯ä»¥å¤ç”¨ current èŠ‚ç‚¹ï¼Œè¿™æ ·å°±èƒ½å…‹éš† current.child ä½œä¸º workInProgress.childï¼Œè€Œä¸éœ€è¦æ–°å»º workInProgress.childã€‚</li> <li>mount æ—¶ï¼šé™¤ fiberRootNode ä»¥å¤–ï¼Œcurrent === nullã€‚ä¼šæ ¹æ® fiber.tag ä¸åŒï¼Œåˆ›å»ºä¸åŒç±»å‹çš„å­ Fiber èŠ‚ç‚¹</li></ul> <p>æ— è®º update æˆ– mountï¼Œå¦‚æœéœ€è¦åˆ›å­èŠ‚ç‚¹ï¼Œéƒ½ä¼šæ ¹æ® workInProgress.tag çš„ç±»å‹èµ°ä¸åŒçš„ component å‡½æ•°åˆ›å»ºå­ Fiber èŠ‚ç‚¹ï¼Œå¦‚ FunctionComponent ç±»å‹èµ°çš„å°±æ˜¯ updateFunctionComponentï¼Œè¿™ä¸ªå‡½æ•°æœ€ç»ˆè°ƒç”¨ reconcileChildren åˆ›å»º workInProgress.child å­èŠ‚ç‚¹ã€‚</p> <p>updateFunctionComponent è¿™ä¸ªå‡½æ•°ä¸­è¿˜è°ƒç”¨äº† renderWithHooksï¼Œåœ¨ renderWithHooks é‡Œæœ‰è¿™ä¹ˆä¸€å¥ <code>let children = Component(props, secondArg);</code>ï¼Œè¿™é‡Œçš„ Component å¯¹åº”çš„ workInProgress.typeï¼Œä¹Ÿå°±æ˜¯ç»„ä»¶çš„å‡½æ•°ã€‚è¿”å›çš„å°±æ˜¯æ–°çš„ JSX ç”Ÿæˆçš„ React.Elementï¼Œç„¶åè¿™ä¸ª React.Element ä¼šä¼ ç»™ reconcileChildren å‡½æ•°ï¼ŒreconcileChildren ç»“åˆ React.Element å’Œ current Fiber èŠ‚ç‚¹åˆ›å»ºæ–°çš„ workInProgress.child å­èŠ‚ç‚¹ï¼Œè¿™é‡Œé¢ä¹Ÿå°±è¿›è¡Œäº† diff è¿‡ç¨‹ã€‚</p> <p>å¯ä»¥è¯´ beginWork å‡½æ•°ä¸»è¦åŠŸèƒ½å°±æ˜¯åˆ›å»ºå½“å‰ Fiber èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªå­ Fiber èŠ‚ç‚¹ã€‚</p> <h3 id="completework-å…·ä½“åšä»€ä¹ˆ"><a href="#completework-å…·ä½“åšä»€ä¹ˆ" class="header-anchor">#</a> completeWork å…·ä½“åšä»€ä¹ˆ</h3> <p>completeWork è¿›å…¥åä¼šæ ¹æ® workInProgress.tag çš„ç±»å‹èµ°ä¸åŒçš„æµç¨‹ã€‚è¿™é‡Œæœ‰äº›ç±»å‹çš„ Fiber èŠ‚ç‚¹ä¼šåˆ›å»ºå¯¹åº”çš„ DOM èŠ‚ç‚¹äº†ï¼Œå¹¶ä¿å­˜åœ¨ workInProgress.stateNode ä¸Šã€‚</p> <p>å½“æ•´ä¸ªåº”ç”¨æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œ completeWork åï¼Œä¼šè¿›å…¥ä¸Šå±‚çš„ performSyncWorkOnRoot å‡½æ•°ï¼Œè¿™é‡Œä¼šæ‹¿åˆ°æ•´ä¸ªåº”ç”¨æ ¹èŠ‚ç‚¹çš„ alternateï¼Œ workInProgress çš„æ ¹èŠ‚ç‚¹ï¼Œæ‰§è¡Œ commitRoot å‡½æ•°ï¼Œæ‰§è¡Œ DOM å‘é¡µé¢çš„æ’å…¥é€»è¾‘ã€‚</p> <h3 id="éé¦–æ¬¡æ¸²æŸ“-update-é˜¶æ®µ"><a href="#éé¦–æ¬¡æ¸²æŸ“-update-é˜¶æ®µ" class="header-anchor">#</a> éé¦–æ¬¡æ¸²æŸ“ update é˜¶æ®µ</h3> <p><strong>â€œé€’â€é˜¶æ®µ</strong></p> <p>è¿›å…¥ beginWork é˜¶æ®µï¼Œæ­¤æ—¶å› ä¸ºæœ‰ current èŠ‚ç‚¹ï¼Œæ‰€ä»¥ä¼šæ ¹æ®æƒ…å†µæ”¹å˜å…¨å±€çš„ didReceiveUpdate çš„å€¼ï¼Œè¿™ä¸ªå€¼ä»£è¡¨äº†æœ¬æ¬¡æ›´æ–°ä¸­å½“å‰ Fiber èŠ‚ç‚¹æ˜¯å¦æœ‰å˜åŒ–ã€‚</p> <ul><li>æ–°æ—§ props æ˜¯å¦ç›¸ç­‰</li> <li>context æ˜¯å¦æœ‰å˜åŒ–</li> <li>type æ˜¯å¦æœ‰å˜åŒ–</li> <li>æœ¬æ¬¡æ›´æ–°åœ¨å½“å‰ Fiber ä¸Šæ˜¯å¦æœ‰è¦è¿›è¡Œçš„ä»»åŠ¡ï¼šcurrent.flags</li></ul> <p>å¯¹äºæ— å˜åŒ–çš„èŠ‚ç‚¹ï¼Œæœ€åä¼šè°ƒç”¨ cloneChildFibersï¼ŒcloneChildFibers ä¸­åˆè°ƒç”¨äº† createWorkInProgress å‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ä»¥å¤ç”¨èŠ‚ç‚¹ã€‚</p> <p>å¯¹äºä¸èƒ½å¤ç”¨çš„èŠ‚ç‚¹ï¼Œåˆ™è¿›å…¥ reconcileChildrenï¼Œè¿™ä¸ªé€»è¾‘ä¸­ä¼šå°† current èŠ‚ç‚¹å’Œæ–°çš„ React.Element åšå¯¹æ¯”ï¼Œç„¶åç”Ÿæˆæ–°çš„ workInProgressã€‚</p> <p><strong>â€œå½’â€é˜¶æ®µ</strong></p> <p>è¿›å…¥ completeWork å¤„ç† Fiber èŠ‚ç‚¹ï¼Œæ ¹æ® workInProgress.tag çš„ç±»å‹èµ°ä¸åŒçš„æµç¨‹ï¼Œæœ€åä¼šè¿› prepareUpdateï¼ŒprepareUpdate åˆè°ƒç”¨äº† diffPropertiesã€‚</p> <p>diffProperties çš„ä½œç”¨æ˜¯æ¯”è¾ƒæ–°æ—§ props çš„å˜åŒ–ã€‚</p> <p>æœ€åè¿”å›çš„æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„çš„ i é¡¹æ˜¯éœ€è¦æ”¹å˜çš„ props keyï¼Œi + 1 é¡¹æ˜¯éœ€è¦æ”¹å˜çš„ props valueã€‚</p> <p>è¿™ä¸ªæ•°ç»„ä¼šä¿å­˜åœ¨ workInProgress.updateQueue ä¸Šã€‚</p> <p>ä¹‹å flags ä¼šåŠ ä¸Š Update çš„æ ‡è®° <code>workInProgress.flags |= Update</code>ï¼Œè¡¨ç¤ºéœ€è¦æ›´æ–° props å±æ€§ã€‚</p> <p>completeWork å®Œæˆåï¼Œåœ¨ä»–çš„ä¸Šå±‚å‡½æ•° completeUnitOfWork ä¸­ï¼Œå°†æœ‰ flags çš„ Fiber èŠ‚ç‚¹ç»„æˆä¸€æ¡é“¾è¡¨ã€‚è¿™æ · commit é˜¶æ®µåªéœ€è¦éå†è¿™ä¸ªé“¾è¡¨å³å¯ã€‚</p> <p>è¿›å…¥ commit é˜¶æ®µåï¼ŒworkInProgress.flags å°±æ˜¯èŠ‚ç‚¹éœ€è¦æ‰§è¡Œ DOM æ“ä½œçš„ä¾æ®ã€‚</p> <h2 id="commit-é˜¶æ®µ"><a href="#commit-é˜¶æ®µ" class="header-anchor">#</a> commit é˜¶æ®µ</h2> <p>commitRoot æ˜¯ commit é˜¶æ®µçš„èµ·ç‚¹ã€‚</p> <p>commit é˜¶æ®µå¹¶ä¸éœ€è¦é‡æ–°éå†æ•´ä¸ª Fiber æ ‘ã€‚workInProgress.flags æœ‰å€¼çš„ Fiber èŠ‚ç‚¹ä¼šåœ¨ completeWork å®Œæˆæ—¶ç»„æˆä¸€æ¡é“¾è¡¨ï¼Œcommit é˜¶æ®µåªéœ€è¦éå†è¿™ä¸ªé“¾è¡¨å³å¯ã€‚</p> <p><strong>æ•´ä¸ª commit é˜¶æ®µå¯ä»¥åˆ†ä¸º before mutationã€mutationã€layoutã€‚</strong></p> <p>commitRoot å®é™…æ‰§è¡Œçš„å‡½æ•°æ˜¯ commitRootImpl å‡½æ•°ã€‚</p> <p>before mutationã€mutationã€layout ä¸‰ä¸ªé˜¶æ®µåˆ†åˆ«å¯¹åº”äº† commitRootImpl ä¸­çš„ commitBeforeMutationEffectsã€commitMutationEffectsã€commitLayoutEffects å¤„ç†å‡½æ•°ã€‚</p> <p>æ–°ç‰ˆ React åœ¨è¿›å…¥ before mutation å‰ä¼šå¼‚æ­¥è°ƒåº¦ useEffect</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// è°ƒåº¦ useEffect</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>
  <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>subtreeFlags <span class="token operator">&amp;</span> PassiveMask<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags <span class="token operator">||</span>
  <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> PassiveMask<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    pendingPassiveEffectsRemainingLanes <span class="token operator">=</span> remainingLanes<span class="token punctuation">;</span>ns <span class="token operator">=</span> transitions<span class="token punctuation">;</span>

    <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>NormalSchedulerPriority<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// è§¦å‘ useEffect</span>
      <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="before-mutation"><a href="#before-mutation" class="header-anchor">#</a> before mutation</h3> <ul><li>å¤„ç† DOM èŠ‚ç‚¹æ¸²æŸ“/åˆ é™¤åçš„ autoFocusã€blur é€»è¾‘ã€‚</li> <li>è°ƒç”¨ getSnapshotBeforeUpdate ç”Ÿå‘½å‘¨æœŸé’©å­ã€‚</li></ul> <h3 id="mutation"><a href="#mutation" class="header-anchor">#</a> mutation</h3> <p>commitMutationEffects å‡½æ•°ä¸­ä¼šæ ¹æ® finishedWork.tag æ‰§è¡Œä¸åŒçš„é€»è¾‘</p> <p><s>ä»¥ FunctionComponent ä¸ºä¾‹ï¼Œå¤§è‡´æµç¨‹å°±æ˜¯å…ˆæ‰§è¡Œæ‰€æœ‰çš„ useEffect çš„é”€æ¯å‡½æ•°ï¼Œæ¥ç€æ‰§è¡Œ commitHookEffectListMountã€‚ï¼ˆå¾ˆè¿·ï¼Œæ²¡æ‡‚ï¼‰</s></p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">commitHookEffectListUnmount</span><span class="token punctuation">(</span>
    HookInsertion <span class="token operator">|</span> HookHasEffect<span class="token punctuation">,</span>
    finishedWork<span class="token punctuation">,</span>
    finishedWork<span class="token punctuation">.</span>return<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">commitHookEffectListMount</span><span class="token punctuation">(</span>
    HookInsertion <span class="token operator">|</span> HookHasEffect<span class="token punctuation">,</span>
    finishedWork<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>å¯¹äº HostComponent ä¹Ÿå°±æ˜¯ DOM èŠ‚ç‚¹ï¼Œæ‰§è¡Œ commitUpdate å‡½æ•°å»å…·ä½“çš„æ›´æ–° DOM èŠ‚ç‚¹çš„å±æ€§ã€‚</p> <h3 id="layout"><a href="#layout" class="header-anchor">#</a> layout</h3> <p>commitMutationEffects ä¹‹å commitLayoutEffects ä¹‹å‰ï¼Œä¼šæ‰§è¡Œ <code>root.current = finishedWork;</code> è¯­å¥ï¼Œä¹Ÿå°±æ˜¯å°† workInProgress Fiber æ ‘å˜æˆäº† current Fiber æ ‘çš„æ“ä½œ</p> <p>commitLayoutEffects ä¼šè·³åˆ° commitLayoutEffectOnFiberï¼ŒcommitLayoutEffectOnFiber ä¸­ä¼šæ ¹æ® finishedWork.tag æ‰§è¡Œä¸åŒçš„é€»è¾‘</p> <p>ä»¥ FunctionComponent ä¸ºä¾‹ï¼Œæ‰§è¡Œäº† commitHookEffectListMountã€‚</p> <p>å¯¹äº ClassComponent ä¸ºä¾‹ï¼Œæ‰§è¡Œäº† componentDidMount æˆ– componentDidUpdate ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ï¼Œç„¶åæ‰§è¡Œ commitUpdateQueueã€‚</p> <p>commitUpdateQueue ä¼šåœ¨ ClassComponent å’Œ HostRoot ä¸¤ç§ç±»å‹ä¸­è¢«è°ƒç”¨ï¼Œè¿™ä¸ªå‡½æ•°ä¼šéå† effect ç„¶åæ‰§è¡Œ callbackï¼Œcallback åœ¨ ClassComponent å°±æ˜¯ this.setState çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚</p> <p><strong>commit é˜¶æ®µå®Œæˆåï¼Œæ‰§è¡Œæ‰€æœ‰çš„ useEffect çš„é”€æ¯å‡½æ•°å’Œå›è°ƒå‡½æ•°</strong></p> <h3 id="useeffect-å’Œ-uselayouteffect-åœ¨-commit-é˜¶æ®µçš„åŒºåˆ«"><a href="#useeffect-å’Œ-uselayouteffect-åœ¨-commit-é˜¶æ®µçš„åŒºåˆ«" class="header-anchor">#</a> useEffect å’Œ useLayoutEffect åœ¨ commit é˜¶æ®µçš„åŒºåˆ«</h3> <table><thead><tr><th style="text-align:center;">é˜¶æ®µ</th> <th style="text-align:center;">useEffect</th> <th style="text-align:center;">useLayoutEffect</th></tr></thead> <tbody><tr><td style="text-align:center;">before mutation</td> <td style="text-align:center;">è°ƒåº¦ flushPassiveEffectsï¼ˆæ–°ç‰ˆæ˜¯åœ¨ before mutation ä¹‹å‰ ï¼‰</td> <td style="text-align:center;">æ— </td></tr> <tr><td style="text-align:center;">mutation</td> <td style="text-align:center;">æ— </td> <td style="text-align:center;">æ‰§è¡Œ destroy</td></tr> <tr><td style="text-align:center;">layout</td> <td style="text-align:center;">æ³¨å†Œ destroyã€create</td> <td style="text-align:center;">æ‰§è¡Œ create</td></tr> <tr><td style="text-align:center;">commit ä¹‹å</td> <td style="text-align:center;">æ‰§è¡Œ flushPassiveEffectsï¼Œå†…éƒ¨æ‰§è¡Œæ³¨å†Œçš„å›è°ƒï¼Œå³ destroyã€create</td> <td style="text-align:center;">æ— </td></tr></tbody></table> <h2 id="diff-ç®—æ³•"><a href="#diff-ç®—æ³•" class="header-anchor">#</a> diff ç®—æ³•</h2> <p>reconcileChildren -&gt; reconcileChildFibersï¼ˆçœŸæ­£ diff ç®—æ³•ï¼‰</p> <p>diff ç®—æ³•çš„æœ¬è´¨æ˜¯ç»“åˆ current Fiber å’Œ JSXï¼ˆReact.Elementï¼‰ ç”Ÿæˆ workInProgress Fiberã€‚</p> <p>diff ä¸ºäº†é™ä½ç®—æ³•å¤æ‚åº¦ï¼Œé¢„è®¾äº†ä¸‰ä¸ªé™åˆ¶</p> <ul><li>åªå¯¹åŒçº§å…ƒç´ è¿›è¡Œ Diffã€‚å¦‚æœä¸€ä¸ª DOM èŠ‚ç‚¹åœ¨å‰åä¸¤æ¬¡æ›´æ–°ä¸­è·¨è¶Šäº†å±‚çº§ï¼Œé‚£ä¹ˆ React ä¸ä¼šå°è¯•å¤ç”¨ä»–ã€‚</li> <li>ä¸¤ä¸ªä¸åŒç±»å‹çš„å…ƒç´ ä¼šäº§ç”Ÿå‡ºä¸åŒçš„æ ‘ã€‚å¦‚æœå…ƒç´ ç”± div å˜ä¸º pï¼ŒReact ä¼šé”€æ¯ div åŠå…¶å­å­™èŠ‚ç‚¹ï¼Œå¹¶æ–°å»º p åŠå…¶å­å­™èŠ‚ç‚¹ã€‚</li> <li>åŒä¸€å±‚çº§çš„å­èŠ‚ç‚¹ï¼Œå¯ä»¥é€šè¿‡æ ‡è®° key çš„æ–¹å¼è¿›è¡Œåˆ—è¡¨å¯¹æ¯”ã€‚è€ƒè™‘å¦‚ä¸‹ä¾‹å­ï¼š</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// æ›´æ–°å‰</span>
<span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>p key<span class="token operator">=</span><span class="token string">&quot;111&quot;</span><span class="token operator">&gt;</span><span class="token number">111</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>h3 key<span class="token operator">=</span><span class="token string">&quot;222&quot;</span><span class="token operator">&gt;</span><span class="token number">222</span><span class="token operator">&lt;</span><span class="token operator">/</span>h3<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>

<span class="token comment">// æ›´æ–°å</span>
<span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>h3 key<span class="token operator">=</span><span class="token string">&quot;222&quot;</span><span class="token operator">&gt;</span><span class="token number">222</span><span class="token operator">&lt;</span><span class="token operator">/</span>h3<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>p key<span class="token operator">=</span><span class="token string">&quot;111&quot;</span><span class="token operator">&gt;</span><span class="token number">111</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>

<span class="token comment">// å¦‚æœæ²¡æœ‰ keyï¼ŒReact ä¼šè®¤ä¸º div çš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ç”± p å˜ä¸º h3ï¼Œç¬¬äºŒä¸ªå­èŠ‚ç‚¹ç”± h3 å˜ä¸º pã€‚è¿™ç¬¦åˆé™åˆ¶ 2 çš„è®¾å®šï¼Œä¼šé”€æ¯å¹¶æ–°å»ºã€‚</span>
<span class="token comment">// å­˜åœ¨ key åˆ™å¯ä»¥å¤ç”¨ã€‚</span>
</code></pre></div><h3 id="diff-çš„å®ç°"><a href="#diff-çš„å®ç°" class="header-anchor">#</a> diff çš„å®ç°</h3> <p>diff çš„å…¥å£æ˜¯ reconcileChildFibersã€‚</p> <p>é¦–å…ˆä¼šåˆ¤æ–­ newChildï¼ˆJSXï¼‰ æ˜¯ä¸æ˜¯ä¸€ä¸ª Fragment ç±»å‹ï¼Œæ¥ç€åˆ¤æ–­æ˜¯ä¸æ˜¯ Object æ‰€å±çš„ç±»å‹ï¼ˆREACT_ELEMENT_TYPEã€REACT_PORTAL_TYPEã€REACT_LAZY_TYPEï¼‰ã€‚</p> <p>åˆ¤æ–­æ˜¯ä¸æ˜¯ä¸€ä¸ª Arrayï¼Œæ˜¯ä¸æ˜¯ä¸€ä¸ª Iterator å¯è¿­ä»£å¯¹è±¡ï¼Œè¿™ä¸¤ç§æƒ…å†µå¤„ç†è¿‡ç¨‹ç±»ä¼¼ï¼Œå¯ä»¥å½“ä½œä¸€ç§å¤„ç†ã€‚</p> <p>åˆ¤æ–­æ˜¯ä¸æ˜¯ä¸€ä¸ª string æˆ– numberï¼Œè¿™å›ä½œä¸ºä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹å¤„ç†ã€‚</p> <p>ä»¥ä¸Šéƒ½ä¸å‘½ä¸­ï¼Œåˆ™æ‰§è¡Œåˆ é™¤é€»è¾‘ã€‚</p> <p>ä»ä¸Šå¯çŸ¥ï¼Œå¤§è‡´å¯ä»¥åˆ†æˆä¸¤ç§æƒ…å†µï¼Œå•ä¸€èŠ‚ç‚¹çš„ diff å’Œ å¤šä¸ªèŠ‚ç‚¹çš„ diffã€‚</p> <h3 id="å•ä¸€èŠ‚ç‚¹çš„-diff"><a href="#å•ä¸€èŠ‚ç‚¹çš„-diff" class="header-anchor">#</a> å•ä¸€èŠ‚ç‚¹çš„ diff</h3> <p>å¯¹äº React.createElement çš„è¿”å›å€¼éƒ½æ˜¯ REACT_ELEMENT_TYPEï¼Œèµ°çš„ reconcileSingleElement å¤„ç†å‡½æ•°ã€‚</p> <p>reconcileSingleElement å‡½æ•°ä¸­ä¼šæ¯”è¾ƒæ˜¯å¦å­˜åœ¨ currentï¼Œå¦‚æœå­˜åœ¨å¹¶ä¸” key å€¼ç›¸åŒå†æ¯”è¾ƒ type ä¸€è‡´å°±å¯ä»¥å¤ç”¨ã€‚å¦åˆ™éœ€è¦åˆ é™¤ï¼Œæ³¨æ„è¿™é‡Œä¼šéå† current çš„ siblingï¼Œè€ƒè™‘åŸæœ¬æ˜¯ li * 3 çš„æƒ…å†µï¼Œæ›´æ–°åæˆä¸º li * 1ï¼Œæ­¤æ—¶ current è¿˜æ˜¯ li * 3ï¼Œä½†æ˜¯èµ°çš„æ˜¯å•ä¸€èŠ‚ç‚¹ diffï¼Œéœ€è¦æ¯”è¾ƒä¸‰ä¸ª li æ˜¯å¦æœ‰å¯ä»¥å¤ç”¨çš„ï¼Œå¹¶ä¸”è¦æŠŠå¤šä½™çš„åˆ é™¤ã€‚å¦‚æœä¸‰ä¸ª li éƒ½ä¸èƒ½å¤ç”¨ï¼Œæœ€åä¼šå•ç‹¬åˆ›å»ºæ–°èŠ‚ç‚¹ã€‚</p> <p><strong>ä¸»è¦æµç¨‹ä»£ç å¦‚ä¸‹</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reconcileSingleElement</span><span class="token punctuation">(</span>
  returnFiber<span class="token operator">:</span> Fiber<span class="token punctuation">,</span> <span class="token comment">// çˆ¶ Fiber</span>
  currentFirstChild<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// current Fiber</span>
  element<span class="token operator">:</span> ReactElement<span class="token punctuation">,</span> <span class="token comment">// JSX</span>
  lanes<span class="token operator">:</span> Lanes<span class="token punctuation">,</span> <span class="token comment">// ä¼˜å…ˆçº§</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> key <span class="token operator">=</span> element<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
  <span class="token keyword">let</span> child <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span>

  <span class="token comment">// éœ€è¦æœ‰ current Fiber æ‰æœ‰å¯èƒ½å¤ç”¨</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>key <span class="token operator">===</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>elementType <span class="token operator">===</span> element<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å…ˆæŠŠå¤šä½™çš„ sibling æ ‡è®°åˆ é™¤</span>
        <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> child<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¤ç”¨ Fiber èŠ‚ç‚¹</span>
        <span class="token function">useFiber</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> element<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ³¨æ„è¿™é‡ŒæŠŠæ•´ä¸ª child[] éƒ½æ ‡è®°åˆ é™¤äº†ï¼Œå¹¶ä¸”è·³å‡ºå¾ªç¯</span>
        <span class="token comment">// ä¹‹æ‰€ä»¥è¿™æ ·æ˜¯å› ä¸ºå…ˆæ¯”è¾ƒäº† key ç›¸åŒï¼Œç»“æœå› ä¸º type ä¸åŒä¸èƒ½å¤ç”¨ï¼Œåç»­çš„ sibling è‚¯å®šä¹Ÿä¸èƒ½å¤ç”¨ï¼Œä¸éœ€æ¯”è¾ƒ</span>
        <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœ key ä¸ç›¸åŒï¼Œéœ€è¦æŠŠ child æ ‡è®°åˆ é™¤ã€‚</span>
      <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// æ³¨æ„è¿™é‡Œä¼šéå† child çš„ siblingï¼Œ</span>
    <span class="token comment">// è€ƒè™‘åŸæœ¬æ˜¯ li * 3 çš„æƒ…å†µï¼Œæ›´æ–°åæˆä¸º li * 1ï¼Œ</span>
    <span class="token comment">// æ­¤æ—¶ child[] è¿˜æ˜¯ li * 3ï¼Œä½†æ˜¯èµ°çš„æ˜¯å•ä¸€èŠ‚ç‚¹ diffï¼Œéœ€è¦æ¯”è¾ƒä¸‰ä¸ª li æ˜¯å¦æœ‰å¯ä»¥å¤ç”¨çš„ï¼Œå¹¶ä¸”è¦æŠŠå¤šä½™çš„æ ‡è®°åˆ é™¤</span>
    child <span class="token operator">=</span> child<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ...</span>
  <span class="token comment">// ä¸Šè¿°å¤ç”¨é€»è¾‘æ²¡æœ‰å‘½ä¸­ï¼Œåˆ›å»ºæ–° Fiber èŠ‚ç‚¹</span>
  <span class="token function">createFiberFromElement</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> returnFiber<span class="token punctuation">.</span>mode<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="å¤šä¸ªèŠ‚ç‚¹çš„-diff"><a href="#å¤šä¸ªèŠ‚ç‚¹çš„-diff" class="header-anchor">#</a> å¤šä¸ªèŠ‚ç‚¹çš„ diff</h3> <p>å¤šä¸ªèŠ‚ç‚¹ diff è¿›å…¥ reconcileChildrenArray å‡½æ•°ã€‚</p> <p>å¤šä¸ªèŠ‚ç‚¹ diff åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š</p> <ul><li>èŠ‚ç‚¹æ›´æ–°ï¼šprops å˜åŒ–ã€èŠ‚ç‚¹ç±»å‹æ›´æ–°ï¼ˆdiv -&gt; liï¼‰</li> <li>èŠ‚ç‚¹æ–°å¢æˆ–å‡å°‘</li> <li>èŠ‚ç‚¹ä½ç½®å˜åŒ–</li></ul> <p>åŒçº§å¤šä¸ªèŠ‚ç‚¹çš„ diffï¼Œä¸€å®šå±äºä»¥ä¸Šä¸‰ç§æƒ…å†µä¸­çš„ä¸€ç§æˆ–å¤šç§ã€‚å…¶ä¸­<strong>èŠ‚ç‚¹æ›´æ–°</strong>çš„é¢‘ç‡æ›´é«˜ï¼Œæ‰€ä»¥ä¼šä¼˜å…ˆåˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦å±äº<code>æ›´æ–°</code>ã€‚</p> <p>ç”±äºæ­¤æ—¶çš„ current Fiber æ˜¯ä¸€ä¸ªå•é“¾è¡¨ç»“æ„ï¼Œè€Œä¸æ˜¯æ•°ç»„ç»“æ„ï¼Œæ‰€ä»¥ diff æ•´ä½“è¿‡ç¨‹ä¸­ä¼šç»å†ä¸¤è½®éå†ã€‚</p> <ul><li>ç¬¬ä¸€è½®éå†ï¼šå¤„ç†<code>æ›´æ–°</code>çš„èŠ‚ç‚¹</li> <li>ç¬¬äºŒè½®éå†ï¼šå¤„ç†å‰©ä¸‹çš„ä¸å±äº<code>æ›´æ–°</code>çš„èŠ‚ç‚¹</li></ul> <p>ç¬¬ä¸€è½®éå†ï¼š</p> <ul><li>let i = 0ï¼Œéå† newChildrenï¼Œå°† newChildren[i] ä¸ oldFiber æ¯”è¾ƒï¼Œåˆ¤æ–­ DOM èŠ‚ç‚¹æ˜¯å¦å¯å¤ç”¨ã€‚</li> <li>å¦‚æœå¯å¤ç”¨ï¼Œi++ï¼Œç»§ç»­æ¯”è¾ƒ newChildren[i] ä¸ oldFiber.siblingï¼Œå¯ä»¥å¤ç”¨åˆ™ç»§ç»­éå†ã€‚</li> <li>å¦‚æœä¸å¯å¤ç”¨ï¼Œåˆ†ä¸¤ç§æƒ…å†µï¼š</li> <li><ul><li>key ä¸åŒå¯¼è‡´ä¸å¯å¤ç”¨ï¼Œç«‹å³è·³å‡ºæ•´ä¸ªéå†ï¼Œç¬¬ä¸€è½®éå†ç»“æŸã€‚ï¼ˆæ­¤æ—¶ newChildren æ²¡æœ‰éå†å®Œï¼ŒoldFiber ä¹Ÿæ²¡æœ‰éå†å®Œã€‚ï¼‰</li></ul></li> <li><ul><li>key ç›¸åŒ type ä¸åŒå¯¼è‡´ä¸å¯å¤ç”¨ï¼Œä¼šå°† oldFiber æ ‡è®°ä¸º Deletionï¼Œå¹¶ç»§ç»­éå†</li></ul></li> <li>å¦‚æœ newChildren éå†å®Œï¼ˆå³ i === newChildren.length - 1 ï¼‰æˆ–è€… oldFiber éå†å®Œï¼ˆå³ oldFiber.sibling === null ï¼‰ï¼Œè·³å‡ºéå†ï¼Œç¬¬ä¸€è½®éå†ç»“æŸã€‚ï¼ˆæ­¤æ—¶å¯èƒ½ newChildren éå†å®Œï¼Œæˆ– oldFiber éå†å®Œï¼Œæˆ–ä»–ä»¬åŒæ—¶éå†å®Œã€‚ï¼‰</li></ul> <p>ç¬¬äºŒè½®éå†ï¼š</p> <ul><li>å¯¹äºç¬¬ä¸€è½®éå†çš„ç»“æœï¼Œåˆ†åˆ«è®¨è®ºï¼š</li> <li><ul><li>newChildren ä¸ oldFiber åŒæ—¶éå†å®Œï¼šæœ€ç†æƒ³çš„æƒ…å†µï¼Œåªéœ€åœ¨ç¬¬ä¸€è½®éå†è¿›è¡Œç»„ä»¶æ›´æ–°ï¼Œæ­¤æ—¶ diffç»“æŸï¼Œè¯¥æƒ…å†µå’Œ oldFiber æ²¡éå†å®Œçš„æƒ…å†µèµ°ç›¸åŒé€»è¾‘ã€‚</li></ul></li> <li><ul><li>newChildren éå†å®Œï¼ŒoldFiber æ²¡éå†å®Œï¼šå‰©ä¸‹çš„ oldFiber éƒ½æ˜¯åˆ é™¤èŠ‚ç‚¹ï¼Œæ ‡è®°åˆ é™¤ Deletion</li></ul></li> <li><ul><li>newChildren æ²¡éå†å®Œï¼ŒoldFiber éå†å®Œï¼šå‰©ä¸‹çš„ newChildren èŠ‚ç‚¹éƒ½æ˜¯æ–°å¢èŠ‚ç‚¹ï¼Œæ ‡è®° Placement</li></ul></li> <li><ul><li>newChildren ä¸ oldFiber éƒ½æ²¡éå†å®Œï¼šå‰©ä¸‹çš„ oldFiber ç»„æˆä¸€ä¸ª key-mapï¼Œå†éå† newChildrenï¼Œé€šè¿‡ key å±æ€§åœ¨ map ä¸­æŸ¥æ‰¾ï¼Œèƒ½å¤ç”¨å¤ç”¨ï¼Œä¸èƒ½å¤ç”¨æ–°å»ºèŠ‚ç‚¹</li></ul></li></ul> <p><strong>ä¸»è¦æµç¨‹ä»£ç å¦‚ä¸‹</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span>
  returnFiber<span class="token operator">:</span> Fiber<span class="token punctuation">,</span> <span class="token comment">// çˆ¶ Fiber</span>
  currentFirstChild<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// current Fiber</span>
  newChildren<span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">// JSX[]</span>
  lanes<span class="token operator">:</span> Lanes<span class="token punctuation">,</span> <span class="token comment">// ä¼˜å…ˆçº§</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span> oldFiber <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// updateSlot ä¸­æ¯”è¾ƒäº† key å’Œ type</span>
    <span class="token comment">// å¦‚æœ key ä¸åŒè¿”å› null</span>
    <span class="token comment">// å¦‚æœ key ç›¸åŒ type ä¸åŒï¼Œè¿”å›åŸºäºæ–° JSX ç”Ÿæˆçš„ Fiber èŠ‚ç‚¹</span>
    <span class="token comment">// å¦‚æœ key å’Œ type éƒ½ç›¸åŒï¼Œè¿”å›å¤ç”¨çš„ oldFiber èŠ‚ç‚¹</span>
    <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">updateSlot</span><span class="token punctuation">(</span>
      returnFiber<span class="token punctuation">,</span>
      oldFiber<span class="token punctuation">,</span>
      newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">,</span>
      lanes<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// key ä¸åŒå¯¼è‡´ä¸å¯å¤ç”¨ï¼Œç«‹å³è·³å‡ºæ•´ä¸ªéå†</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newFiber <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>
    <span class="token comment">// newFiber.alternate ä¸æ˜¯ oldFiberï¼Œè¯´æ˜ key ç›¸åŒ type ä¸åŒå¯¼è‡´ä¸å¯å¤ç”¨ï¼Œä¼šå°† oldFiber æ ‡è®°ä¸º Deletionï¼Œå¹¶ç»§ç»­éå†</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">&amp;&amp;</span> newFiber<span class="token punctuation">.</span>alternate <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>newIdx <span class="token operator">===</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// newChildren éå†å®Œï¼Œæ­¤æ—¶ oldFiber å¯èƒ½éå†å®Œä¹Ÿå¯èƒ½æ²¡éå†å®Œ</span>
    <span class="token comment">// æ— è®ºæ˜¯å¦æœ‰å‰©ä¸‹çš„ oldFiberï¼Œéƒ½ä¸ºåˆ é™¤èŠ‚ç‚¹ï¼Œæ ‡è®°åˆ é™¤ Deletion</span>
    <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å‰©ä¸‹çš„ newChildren èŠ‚ç‚¹éƒ½æ˜¯æ–°å¢èŠ‚ç‚¹ï¼Œæ ‡è®° Placement</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> lastPlacedIndex<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ...</span>
  <span class="token comment">// newChildren ä¸ oldFiber éƒ½æ²¡éå†å®Œï¼Œæ­¤æ—¶æŠŠå‰©ä¸‹çš„ oldFiber ç”Ÿæˆä¸€ä¸ª key map</span>
  <span class="token function">mapRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span>

  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å†éå†ä¸€æ¬¡ newChildren å† key map ä¸­æŸ¥æ‰¾èƒ½å¦å¤ç”¨</span>
    <span class="token comment">// updateFromMap å‡½æ•°ä¸­ä¼šæ‰¾åˆ° key ç›¸åŒçš„ oldFiberï¼Œç„¶åæ¯”è¾ƒ typeï¼Œèƒ½å¤ç”¨å¤ç”¨ï¼Œä¸èƒ½å¤ç”¨æˆ–æ²¡æœ‰ç›¸åŒ key åˆ™æ–°å»º Fiber èŠ‚ç‚¹</span>
    <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">updateFromMap</span><span class="token punctuation">(</span>
      existingChildren<span class="token punctuation">,</span>
      returnFiber<span class="token punctuation">,</span>
      newIdx<span class="token punctuation">,</span>
      newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">,</span>
      lanes<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token comment">//...</span>
    <span class="token comment">// å¦‚æœå¤ç”¨äº†ï¼Œåˆ é™¤ map ä¸­å¯¹åº”çš„ oldFiber</span>
    <span class="token comment">// æ ‡è®°æ–°å¢çš„æ“ä½œ</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="çŠ¶æ€æ›´æ–°æœºåˆ¶"><a href="#çŠ¶æ€æ›´æ–°æœºåˆ¶" class="header-anchor">#</a> çŠ¶æ€æ›´æ–°æœºåˆ¶</h2> <p>æ¯æ¬¡çŠ¶æ€æ›´æ–°éƒ½ä¼šåˆ›å»ºä¸€ä¸ªä¿å­˜æ›´æ–°çŠ¶æ€ç›¸å…³å†…å®¹çš„å¯¹è±¡ï¼Œå« <code>Update</code>ã€‚åœ¨ render çš„ beginWork ä¸­ä¼šæ ¹æ® Update è®¡ç®—æ–°çš„ stateã€‚</p> <p>å½“ <code>[num, setNum] = useState(1)</code> çš„ setNum è¢«è°ƒç”¨æ—¶ï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨äº† dispatchActionï¼Œå‡½æ•°å†…ä¼šåˆ›å»ºä¸€ä¸ª Update å¯¹è±¡ï¼Œè¿™æ˜¯ä¸€ä¸ªç¯è½¬é“¾è¡¨ç»“æ„ï¼Œè¿™ä¸ª Update å¯¹è±¡ä¼šä¿å­˜åœ¨å¯¹åº” hook å¯¹è±¡çš„ queue.pending ä¸Šï¼Œè€Œç»„ä»¶å†…è°ƒç”¨çš„æ‰€æœ‰ hook å·²é“¾è¡¨ç»“æ„å­˜åœ¨ç»„ä»¶ fiber ä¸Šã€‚æ¥ç€æ ¹æ®ç»„ä»¶çš„ fiber å‘ä¸Šæ‰¾åˆ° root æ³¨å†Œè°ƒåº¦ï¼Œæ‰§è¡Œè°ƒåº¦æ›´æ–°è¿›å…¥ render é˜¶æ®µï¼Œæ·±åº¦éå†ï¼Œå›åˆ° fiber èŠ‚ç‚¹å‘ï¼Œå†æ¬¡æ‰§è¡Œç»„ä»¶å‡½æ•°ã€‚ä¸åŒä¸Šä¸‹æ–‡ï¼ˆå³ï¼šmountã€updateï¼‰ä¸­ useState çš„å…·ä½“å®ç°æ˜¯ä¸åŒçš„ã€‚</p> <h2 id="æç®€-hooks-çš„å®ç°"><a href="#æç®€-hooks-çš„å®ç°" class="header-anchor">#</a> æç®€ hooks çš„å®ç°</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> isMount <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> workInProgressHook <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token punctuation">{</span>
  memoizedState<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  stateNode<span class="token operator">:</span> App<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// useState å®ç°</span>
<span class="token keyword">function</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter">queue<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ›å»ºupdate</span>
  <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token punctuation">{</span>
    action<span class="token punctuation">,</span>
    next<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ç¯çŠ¶å•å‘é“¾è¡¨æ“ä½œ</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>pending <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    update<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 3 -&gt; 0 -&gt; 1 -&gt; 2 -&gt; 3</span>
    <span class="token comment">// 4 -&gt; 0 -&gt; 1 -&gt; 2 -&gt; 3 -&gt; 4</span>
    <span class="token comment">// queue.pending æ˜¯æœ€åä¸€ä¸ª</span>

    update<span class="token punctuation">.</span>next <span class="token operator">=</span> queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  queue<span class="token punctuation">.</span>pending <span class="token operator">=</span> update<span class="token punctuation">;</span>

  <span class="token comment">// æ¨¡æ‹Ÿ Reactå¼€å§‹è°ƒåº¦æ›´æ–°</span>
  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> hook<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isMount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// mountæ—¶ä¸ºè¯¥useStateç”Ÿæˆhook</span>
    hook <span class="token operator">=</span> <span class="token punctuation">{</span>
      queue<span class="token operator">:</span> <span class="token punctuation">{</span>
        pending<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      memoizedState<span class="token operator">:</span> initialState<span class="token punctuation">,</span>
      next<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å°†hookæ’å…¥fiber.memoizedStateé“¾è¡¨æœ«å°¾</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fiber<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> hook<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      workInProgressHook<span class="token punctuation">.</span>next <span class="token operator">=</span> hook<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ç§»åŠ¨workInProgressHookæŒ‡é’ˆ</span>
    workInProgressHook <span class="token operator">=</span> hook<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// updateæ—¶æ‰¾åˆ°å¯¹åº”hook</span>
    hook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">;</span>
    <span class="token comment">// ç§»åŠ¨workInProgressHookæŒ‡é’ˆ</span>
    workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// updateæ‰§è¡Œå‰çš„åˆå§‹state</span>
  <span class="token keyword">let</span> baseState <span class="token operator">=</span> hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–updateç¯çŠ¶å•å‘é“¾è¡¨ä¸­ç¬¬ä¸€ä¸ªupdate</span>
    <span class="token keyword">let</span> firstUpdate <span class="token operator">=</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>

    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ‰§è¡Œupdate action</span>
      <span class="token keyword">const</span> action <span class="token operator">=</span> firstUpdate<span class="token punctuation">.</span>action<span class="token punctuation">;</span>
      baseState <span class="token operator">=</span> <span class="token function">action</span><span class="token punctuation">(</span>baseState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      firstUpdate <span class="token operator">=</span> firstUpdate<span class="token punctuation">.</span>next<span class="token punctuation">;</span>

      <span class="token comment">// æœ€åä¸€ä¸ªupdateæ‰§è¡Œå®Œåè·³å‡ºå¾ªç¯</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span>firstUpdate <span class="token operator">!==</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next<span class="token punctuation">)</span>

    <span class="token comment">// æ¸…ç©ºqueue.pending</span>
    hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// å°†update actionæ‰§è¡Œå®Œåçš„stateä½œä¸ºmemoizedState</span>
  hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> baseState<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>baseState<span class="token punctuation">,</span> <span class="token function">dispatchAction</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  workInProgressHook <span class="token operator">=</span> fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> fiber<span class="token punctuation">.</span><span class="token function">stateNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  isMount <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> app<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>num<span class="token punctuation">,</span> setNum<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">num = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>num<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, state = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setNum</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token operator">=&gt;</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">onToggle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>num<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// test</span>
window<span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">onToggle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="build-your-own-react"><a href="#build-your-own-react" class="header-anchor">#</a> build your own react</h2> <p><a href="https://pomb.us/build-your-own-react/" target="_blank" rel="noopener noreferrer">åŸæ–‡é“¾æ¥<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://www.tangdingblog.cn/blog/react/buildyourownreact-2020-09-22/" target="_blank" rel="noopener noreferrer">ä¸­æ–‡ç‰ˆæœ¬<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://codesandbox.io/s/didact-8-21ost" target="_blank" rel="noopener noreferrer">codeSandbox<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>å°†ä¼šå®ç°çš„åŠŸèƒ½</p> <ol><li>createElement å‡½æ•°</li> <li>render å‡½æ•°</li> <li>Concurrent mode</li> <li>Fibers</li> <li>Render å’Œ Commit é˜¶æ®µ</li> <li>Reconciliation</li> <li>Function Components</li> <li>Hooks</li></ol> <h3 id="createelement-å‡½æ•°"><a href="#createelement-å‡½æ•°" class="header-anchor">#</a> createElement å‡½æ•°</h3> <p>åœ¨ jsx å‡½æ•°å‰ä½¿ç”¨ <code>/** @jsx Didact.createElement */</code> æ³¨é‡Šå¯ä»¥å‘Šè¯‰ç¼–è¾‘å™¨ä½¿ç”¨ Didact.createElement ä»£æ›¿ React.createElement å¤„ç† jsx</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">/** @jsx Didact.createElement */</span>
<span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>foo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">bar</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>props<span class="token punctuation">,</span>
      <span class="token comment">// è€ƒè™‘åŸºæœ¬ç±»å‹æˆ–è€…ç©ºèŠ‚ç‚¹</span>
      children<span class="token operator">:</span> children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span>
        <span class="token keyword">typeof</span> child <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">?</span> child <span class="token operator">:</span> <span class="token function">createTextElement</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// åœ¨å®é™…çš„ react ä»£ç ä¸­æ˜¯ä¸ä¼šå»æŠŠè¿™äº›åŸºæœ¬ç±»å‹æˆ–è€…ç©ºèŠ‚ç‚¹ç»™åŒ…è£…æˆå¯¹è±¡çš„</span>
<span class="token keyword">function</span> <span class="token function">createTextElement</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;TEXT_ELEMENT&quot;</span><span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">{</span>
      nodeValue<span class="token operator">:</span> text<span class="token punctuation">,</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> Didact <span class="token operator">=</span> <span class="token punctuation">{</span>
  createElement<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="render-å‡½æ•°"><a href="#render-å‡½æ•°" class="header-anchor">#</a> render å‡½æ•°</h3> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dom <span class="token operator">=</span> 
    element<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;TEXT_ELEMENT&quot;</span>
    <span class="token operator">?</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
    <span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> children<span class="token punctuation">,</span> <span class="token operator">...</span>props<span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>props<span class="token punctuation">;</span>

  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    dom<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> props<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> dom<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>dom<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> Didact <span class="token operator">=</span> <span class="token punctuation">{</span>
  render
<span class="token punctuation">}</span>

<span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span>
Didact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
</code></pre></div><h3 id="concurrent-mode"><a href="#concurrent-mode" class="header-anchor">#</a> Concurrent Mode</h3> <p>ç›®å‰ä¸ºæ­¢ï¼Œrendering æ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œä¸€æ—¦å¼€å§‹ï¼Œåœ¨ react element æ ‘é€’å½’å®Œæˆå‰éƒ½ä¸èƒ½åœæ­¢ã€‚</p> <p>ç°åœ¨éœ€è¦æŠŠå·¥ä½œæ‹†æˆä¸€ä¸ªä¸ªå°çš„å•å…ƒï¼Œæ¯ä¸ªå•å…ƒå·¥ä½œå®ŒæˆåæŸ¥çœ‹ä¸€ä¸‹æµè§ˆå™¨æ˜¯å¦æœ‰æ›´é‡è¦çš„å·¥ä½œï¼Œå¦‚æœæœ‰å°±æ‰“æ–­å½“å‰çš„æ¸²æŸ“å¾ªç¯ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> nextUnitOfWork <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> shouldYield <span class="token operator">=</span> <span class="token boolean">false</span>

  <span class="token comment">// å¦‚æœè¿˜æœ‰å·¥ä½œæ²¡å®Œæˆ &amp;&amp; ä¸åº”è¯¥ä¸­æ–­</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>nextUnitOfWork <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>shouldYield<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ‰§è¡Œä¸€ä¸ªå•å…ƒçš„å·¥ä½œï¼Œç„¶åæŠŠ nextUnitOfWork å¾€åç§»</span>
    <span class="token comment">// performUnitOfWork å‡½æ•°é™¤äº†æ‰§è¡Œä¸€ä¸ªå°å•å…ƒçš„å·¥ä½œå¤–ï¼Œè¿˜éœ€è¦è¿”å›ä¸‹ä¸€ä¸ªéœ€è¦è¢«æ‰§è¡Œçš„å•å…ƒå·¥ä½œ</span>
    nextUnitOfWork <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>
      nextUnitOfWork
    <span class="token punctuation">)</span>

    <span class="token comment">// æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ—¶é—´ï¼Œå¦‚æœå‰©ä½™æ—¶é—´å°äº 1ï¼Œé‚£ä¹ˆåº”è¯¥ä¸­æ–­äº†</span>
    shouldYield <span class="token operator">=</span> deadline<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// æ³¨å†Œåœ¨ä¸‹ä¸€ä¸ªæµè§ˆå™¨ç©ºä½™æ—¶é—´é‡Œç»§ç»­æ‰§è¡Œå·¥ä½œ</span>
  <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">nextUnitOfWork</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// TODO</span>
<span class="token punctuation">}</span>
</code></pre></div><p>react å¹¶ä¸æ˜¯ä½¿ç”¨ requestIdleCallbackï¼Œå®ƒåœ¨ scheduler package ä¸­å®ç°äº†å’Œ requestIdleCallback ä¸€æ ·çš„åŠŸèƒ½ã€‚</p> <h3 id="fibers"><a href="#fibers" class="header-anchor">#</a> Fibers</h3> <p>ä¸ºäº†æ›´å¥½çš„å®ç°å•å…ƒå·¥ä½œï¼ˆunit of workï¼‰æˆ‘ä»¬éœ€è¦å¼•å…¥åä¸º fiber çš„æ•°æ®ç»“æ„ã€‚æ¯ä¸€ä¸ª react element éƒ½å°†å¯¹åº”ä¸€ä¸ª fiber ç»“æ„ï¼Œæ¯ä¸€ä¸ª fiber ç»“æ„éƒ½å¯¹åº”ä¸€ä¸ªå•å…ƒçš„å·¥ä½œã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// æœ‰è¿™æ ·çš„ä¸€ä¸ªéœ€è¦æ¸²æŸ“çš„å…ƒç´ æ ‘</span>

Didact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>p <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>a <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>h2 <span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  container
<span class="token punctuation">)</span>

<span class="token comment">// å¯¹åº”çš„ fiber æ ‘å¦‚ä¸‹ï¼š</span>
<span class="token comment">// è¿™é‡Œçš„ parent å®é™…ä¸Šæ˜¯ return</span>
<span class="token comment">// root --- child ---&gt; &lt;div&gt; --- child ---&gt; &lt;h1&gt; --- child ---&gt; &lt;p&gt;</span>
<span class="token comment">//    | &lt;--- parent ------ | &lt;--- parent ----- | &lt;--- parent --- |</span>
<span class="token comment">//                         |                   |                 sibling</span>
<span class="token comment">//                         |                   |                 |</span>
<span class="token comment">//                         |                   |                 v</span>
<span class="token comment">//                         |                   | &lt;--- parent -- &lt;a&gt;</span>
<span class="token comment">//                         |                   |</span>
<span class="token comment">//                         |                   sibling</span>
<span class="token comment">//                         |                   | </span>
<span class="token comment">//                         |                   v</span>
<span class="token comment">//                         | &lt;--- parent -- &lt;h2&gt;</span>
</code></pre></div><p>åœ¨ render ä¸­æˆ‘ä»¬éœ€è¦åˆ›å»º root fiberï¼ˆæ ¹ fiberï¼‰ç„¶ååœ¨ nextUnitOfWork ä¸­è®¾ç½®å®ƒã€‚å‰©ä¸‹çš„å·¥ä½œå°†åœ¨ performUnitOfWork å‡½æ•°ä¸­å®Œæˆï¼Œæˆ‘ä»¬å°†å¯¹æ¯ä¸€ä¸ª fiber èŠ‚ç‚¹åšä¸‰ä»¶äº‹ï¼š</p> <ul><li>æŠŠ react element æ¸²æŸ“åˆ° dom ä¸Šã€‚</li> <li>ç»™ react element å­èŠ‚ç‚¹åˆ›å»º fiber èŠ‚ç‚¹ã€‚</li> <li>é€‰æ‹©ä¸‹ä¸€ä¸ªçš„å•å…ƒå·¥ä½œ</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createDom</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dom <span class="token operator">=</span> 
    fiber<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;TEXT_ELEMENT&quot;</span>
    <span class="token operator">?</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
    <span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> children<span class="token punctuation">,</span> <span class="token operator">...</span>props<span class="token punctuation">}</span> <span class="token operator">=</span> fiber<span class="token punctuation">.</span>props<span class="token punctuation">;</span>

  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    dom<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> props<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> dom
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è¿™é‡Œç›¸å½“äºåˆ›å»ºäº†ä¸€ä¸ªå·¥ä½œå•å…ƒï¼Œé…åˆ requestIdleCallback(workLoop)</span>
  <span class="token comment">// å°±èƒ½å®ç°åœ¨æµè§ˆå™¨ç©ºé—²æ—¶æ‰§è¡Œå…·ä½“çš„å·¥ä½œ</span>
  nextUnitOfWork <span class="token operator">=</span> <span class="token punctuation">{</span>
    dom<span class="token operator">:</span> container<span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">{</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span>element<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> nextUnitOfWork <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// 1. æŠŠ react element æ¸²æŸ“æˆ dom</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fiber<span class="token punctuation">.</span>dom <span class="token operator">=</span> <span class="token function">createDom</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fiber<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>dom<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 2. åˆ›å»ºå­ fiber èŠ‚ç‚¹</span>
  <span class="token keyword">const</span> elements <span class="token operator">=</span> fiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children
  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">let</span> prevSibling <span class="token operator">=</span> <span class="token keyword">null</span>

  <span class="token keyword">while</span><span class="token punctuation">(</span>index <span class="token operator">&lt;</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ele <span class="token operator">=</span> elements<span class="token punctuation">[</span>index<span class="token punctuation">]</span>

    <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> ele<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
      props<span class="token operator">:</span> ele<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
      parent<span class="token operator">:</span> fiber<span class="token punctuation">,</span>
      dom<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// çˆ¶ fiber çš„ child åªä¼šæŒ‡å‘ç¬¬ä¸€ä¸ªå­ fiber</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fiber<span class="token punctuation">.</span>child <span class="token operator">=</span> newFiber
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      prevSibling<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber
    <span class="token punctuation">}</span>

    prevSibling <span class="token operator">=</span> newFiber
    index<span class="token operator">++</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 3. è¿”å›ä¸‹ä¸€ä¸ªå•å…ƒå·¥ä½œ</span>
  <span class="token comment">// fiber æ‹¥æœ‰ child å±æ€§å¯ä»¥æŒ‡å‘ä¸‹ä¸€ä¸ªéœ€è¦è¿›è¡Œå·¥ä½œçš„ fiber èŠ‚ç‚¹ã€‚</span>
  <span class="token comment">// å¦‚æœæ²¡æœ‰ child åˆ™ä½¿ç”¨ sibling ä»£è¡¨ä¸‹ä¸€ä¸ªéœ€è¦è¿›è¡Œå·¥ä½œçš„ fiber èŠ‚ç‚¹ã€‚</span>
  <span class="token comment">// å¦‚æœæ²¡æœ‰ sibling åˆ™éœ€è¦å¾€ä¸Šæ‰¾çˆ¶èŠ‚ç‚¹çš„ siblingã€‚</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fiber<span class="token punctuation">.</span>child
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> nextFiber <span class="token operator">=</span> fiber

  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> nextFiber<span class="token punctuation">.</span>sibling
    <span class="token punctuation">}</span>
    nextFiber <span class="token operator">=</span> nextFiber<span class="token punctuation">.</span>parent
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="render-å’Œ-commit-é˜¶æ®µ"><a href="#render-å’Œ-commit-é˜¶æ®µ" class="header-anchor">#</a> Render å’Œ Commit é˜¶æ®µ</h3> <p>åœ¨ä¸Šé¢çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬åœ¨æ¯ä¸€ä¸ªå·¥ä½œå•å…ƒä¸­æ·»åŠ  node èŠ‚ç‚¹åˆ° document ä¸Šé¢ã€‚ä½†æ˜¯æˆ‘ä»¬åœ¨è®¾è®¡ render çš„æ—¶å€™ï¼Œæµè§ˆå™¨å¯ä»¥éšæ—¶åœ¨ç¹å¿™çš„æ—¶å€™æ‰“æ–­æˆ‘ä»¬çš„å·¥ä½œï¼Œè¿™æ ·æˆ‘ä»¬å¯èƒ½ä¼šçœ‹åˆ°ä¸€ä¸ªä¸å®Œæ•´çš„ ui æ¸²æŸ“ã€‚</p> <p>æ‰€ä»¥å®é™…ä¸Šåº”è¯¥æŠŠæ ¹ fiber èŠ‚ç‚¹è®°å½•ä¸‹æ¥ï¼Œä¸€æ—¦å®Œæˆäº†æ‰€æœ‰çš„å·¥ä½œï¼ˆå³ä¸å­˜åœ¨ nextUnitOfWorkï¼‰çš„æ—¶å€™ï¼Œä¸€æ¬¡æ€§æŠŠæ•´ä¸ª fiber æ ‘æ›´æ–°åˆ° document ä¸Šé¢ï¼Œåˆ é™¤ performUnitOfWork ä¸­çš„ <code>fiber.parent.dom.appendChild(fiber.dom)</code>ã€‚</p> <p>è¿™æ ·ä¹Ÿå°±æ˜¯åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µäº†ï¼Œrender é˜¶æ®µéšæ—¶å¯ä»¥ä¸­æ–­ï¼Œåªæ ‡è®°æ›´æ–°è€Œä¸æ“ä½œ domï¼ˆæŒ‡ä¸æ¸²æŸ“åˆ°ç•Œé¢ä¸Šï¼‰ï¼Œcommit é˜¶æ®µåŒæ­¥æ‰§è¡Œï¼Œæ›´æ–° domã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// commit é˜¶æ®µ</span>
<span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>wipRoot<span class="token punctuation">.</span>child<span class="token punctuation">)</span>
  wipRoot <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> domParent <span class="token operator">=</span> fiber<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>dom
  domParent<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// render é˜¶æ®µ</span>
<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// æµç¨‹æ ‘</span>
  wipRoot <span class="token operator">=</span> <span class="token punctuation">{</span>
    dom<span class="token operator">:</span> container<span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">{</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span>element<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  nextUnitOfWork <span class="token operator">=</span> wipRoot
<span class="token punctuation">}</span>

<span class="token keyword">let</span> nextUnitOfWork <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">let</span> wipRoot <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> shouldYield <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextUnitOfWork <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>shouldYield<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    nextUnitOfWork <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>
      nextUnitOfWork
    <span class="token punctuation">)</span>
    shouldYield <span class="token operator">=</span> deadline<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>

â€‹  <span class="token comment">// ä¸€æ¬¡æ€§å…¨éƒ¨æäº¤</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nextUnitOfWork <span class="token operator">&amp;&amp;</span> wipRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="reconciliation"><a href="#reconciliation" class="header-anchor">#</a> <a href="https://codesandbox.io/s/didact-6-96533" target="_blank" rel="noopener noreferrer">Reconciliation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h3> <p>ç›®å‰æˆ‘ä»¬åªè€ƒè™‘äº†å¾€ document ä¸Šé¢æ·»åŠ å…ƒç´ ï¼Œæ›´æ–°å’Œåˆ é™¤å´æ²¡æœ‰å»åšã€‚æˆ‘ä»¬ç°åœ¨æ¥æ·»åŠ è¿™éƒ¨åˆ†çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦æ¯”è¾ƒ render å‡½æ•°è¿™æ¬¡æ”¶åˆ°çš„ fiber ç»“æ„å’Œæˆ‘ä»¬ä¸Šæ¬¡æ›´æ–°çš„ fiber æ ‘çš„ä¸åŒã€‚</p> <p>å› æ­¤æˆ‘ä»¬éœ€è¦åœ¨æ›´æ–°å®Œæ¯•ä¹‹åä¿å­˜ä¸€ä»½æ›´æ–°è¿‡çš„ fiber æ ‘ï¼Œæˆ‘ä»¬å«å®ƒ currentRootã€‚åœ¨æ¯ä¸€ä¸ª fiber èŠ‚ç‚¹å½“ä¸­æˆ‘ä»¬ä¹Ÿæ·»åŠ  alternate å±æ€§ï¼Œè¯¥å±æ€§æŒ‡å‘ä¸Šæ¬¡æ›´æ–°çš„ fiber èŠ‚ç‚¹ã€‚</p> <p>æˆ‘ä»¬åŒæ—¶å¾ªç¯è€çš„ fiber æ ‘çš„å­èŠ‚ç‚¹å’Œæˆ‘ä»¬éœ€è¦è°ƒå’Œæ–°çš„çš„ react èŠ‚ç‚¹ï¼Œæ­¤åˆ»åªå…³å¿ƒ oldFiber å’Œ react elementã€‚react element æ˜¯æˆ‘ä»¬æƒ³è¦æ›´æ–°åˆ° document ä¸Šé¢çš„å…ƒç´ ï¼ŒoldFiber æ˜¯æˆ‘ä»¬ä¸Šæ¬¡æ›´æ–°å®Œæ¯•çš„è€çš„ fiber èŠ‚ç‚¹ã€‚æˆ‘ä»¬éœ€è¦æ¯”è¾ƒä»–ä»¬ï¼Œå¦‚æœå‰åæœ‰ä»»ä½•çš„æ”¹å˜éƒ½éœ€è¦æ›´æ–°åˆ° document ä¸Šé¢ã€‚</p> <p>æˆ‘ä»¬ä½¿ç”¨ type æ¥å¯¹ä»–ä»¬è¿›è¡Œæ¯”è¾ƒï¼š</p> <ul><li>å¦‚æœ old fiber å’Œ react element éƒ½æ‹¥æœ‰ç›¸åŒçš„ typeï¼ˆdom èŠ‚ç‚¹ç›¸åŒï¼‰ï¼Œæˆ‘ä»¬åªéœ€è¦æ›´æ–°å®ƒçš„å±æ€§ã€‚</li> <li>å¦‚æœ type ä¸åŒè¯´æ˜è¿™é‡Œæ›¿æ¢æˆäº†æ–°çš„ dom èŠ‚ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºã€‚</li> <li>å¦‚æœ type ä¸åŒä¸”åŒçº§ä»…å­˜åœ¨ old fiber è¯´æ˜èŠ‚ç‚¹è€èŠ‚ç‚¹åˆ é™¤äº†ï¼Œæˆ‘ä»¬éœ€è¦ç§»é™¤è€çš„èŠ‚ç‚¹ã€‚</li></ul> <p>react æºç ä¸­è¿˜ä½¿ç”¨äº† key æ¥è¿›è¡Œè°ƒåº¦è°ƒå’Œçš„ä¼˜åŒ–ã€‚æ¯”å¦‚é€šè¿‡æ¯”è¾ƒ key å±æ€§å¯ä»¥å¾—åˆ° react elements ä¸­è¢«æ›¿æ¢çš„æ˜ç¡®ä½ç½®ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// commit</span>
<span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ é™¤èŠ‚ç‚¹æ“ä½œ</span>
  deletions<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>commitWork<span class="token punctuation">)</span>

  <span class="token function">commitWork</span><span class="token punctuation">(</span>wipRoot<span class="token punctuation">.</span>child<span class="token punctuation">)</span>
  <span class="token comment">// æ·»åŠ  currentRoot</span>
  currentRoot <span class="token operator">=</span> wipRoot
  wipRoot <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> domParent <span class="token operator">=</span> fiber<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>dom
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    fiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">&quot;PLACEMENT&quot;</span> <span class="token operator">&amp;&amp;</span>
    fiber<span class="token punctuation">.</span>dom <span class="token operator">!=</span> <span class="token keyword">null</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    domParent<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
    fiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">&quot;UPDATE&quot;</span> <span class="token operator">&amp;&amp;</span>
    fiber<span class="token punctuation">.</span>dom <span class="token operator">!=</span> <span class="token keyword">null</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">updateDom</span><span class="token punctuation">(</span>
      fiber<span class="token punctuation">.</span>dom<span class="token punctuation">,</span>
      fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
      fiber<span class="token punctuation">.</span>props
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">&quot;DELETION&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    domParent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
â€‹
  <span class="token function">commitWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">isEvent</span> <span class="token operator">=</span> <span class="token parameter">key</span> <span class="token operator">=&gt;</span> key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;on&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">isProperty</span> <span class="token operator">=</span> <span class="token parameter">key</span> <span class="token operator">=&gt;</span>
  key <span class="token operator">!==</span> <span class="token string">&quot;children&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isEvent</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">isNew</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token parameter">key</span> <span class="token operator">=&gt;</span>
  prev<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> next<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
<span class="token keyword">const</span> <span class="token function-variable function">isGone</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> next<span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">updateDom</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> prevProps<span class="token punctuation">,</span> nextProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Remove old or changed event listeners</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isEvent<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
      <span class="token parameter">key</span> <span class="token operator">=&gt;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> nextProps<span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token function">isNew</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> eventType <span class="token operator">=</span> name
        <span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
      dom<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>
        eventType<span class="token punctuation">,</span>
        prevProps<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
â€‹
  <span class="token comment">// Set new or changed properties</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isProperty<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">isNew</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      dom<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> nextProps<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// Add event listeners</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isEvent<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">isNew</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> eventType <span class="token operator">=</span> name
        <span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
      dom<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
        eventType<span class="token punctuation">,</span>
        nextProps<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// render</span>
<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  wipRoot <span class="token operator">=</span> <span class="token punctuation">{</span>
    dom<span class="token operator">:</span> container<span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">{</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span>element<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// æ·»åŠ  alternate</span>
    alternate<span class="token operator">:</span> currentRoot<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// æ–°å¢è®°å½•åˆ é™¤çš„æ•°ç»„</span>
  deletions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  nextUnitOfWork <span class="token operator">=</span> wipRoot
<span class="token punctuation">}</span>

<span class="token keyword">let</span> nextUnitOfWork <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">let</span> currentRoot <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">let</span> wipRoot <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token comment">// æ–°å¢è®°å½•åˆ é™¤çš„æ•°ç»„</span>
<span class="token keyword">let</span> deletions <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fiber<span class="token punctuation">.</span>dom <span class="token operator">=</span> <span class="token function">createDom</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
â€‹
  <span class="token comment">// åˆ›å»ºæ–° fiber èŠ‚ç‚¹éƒ¨åˆ†çš„ä»£ç æŠ½å–æˆ reconcileChildren å‡½æ•°ã€‚å°†åœ¨ reconcileChildren å‡½æ•°ä¸­æ ¹æ®è€çš„ fiber èŠ‚ç‚¹æ¥è°ƒå’Œæ–°çš„ react å…ƒç´ ã€‚</span>
  <span class="token keyword">const</span> elements <span class="token operator">=</span> fiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children
  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> elements<span class="token punctuation">)</span>
â€‹
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fiber<span class="token punctuation">.</span>child
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> nextFiber <span class="token operator">=</span> fiber

  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> nextFiber<span class="token punctuation">.</span>sibling
    <span class="token punctuation">}</span>
    nextFiber <span class="token operator">=</span> nextFiber<span class="token punctuation">.</span>parent
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token parameter">wipFiber<span class="token punctuation">,</span> elements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">let</span> oldFiber <span class="token operator">=</span>
    wipFiber<span class="token punctuation">.</span>alternate <span class="token operator">&amp;&amp;</span> wipFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>child
  <span class="token keyword">let</span> prevSibling <span class="token operator">=</span> <span class="token keyword">null</span>

   <span class="token keyword">while</span> <span class="token punctuation">(</span>
    index <span class="token operator">&lt;</span> elements<span class="token punctuation">.</span>length <span class="token operator">||</span>
    oldFiber <span class="token operator">!=</span> <span class="token keyword">null</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ele <span class="token operator">=</span> elements<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
    <span class="token keyword">let</span> newFiber <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">const</span> sameType <span class="token operator">=</span>
      oldFiber <span class="token operator">&amp;&amp;</span>
      ele <span class="token operator">&amp;&amp;</span>
      ele<span class="token punctuation">.</span>type <span class="token operator">==</span> oldFiber<span class="token punctuation">.</span>type
â€‹
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sameType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// update the node</span>
      newFiber <span class="token operator">=</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> oldFiber<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
        props<span class="token operator">:</span> element<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
        dom<span class="token operator">:</span> oldFiber<span class="token punctuation">.</span>dom<span class="token punctuation">,</span>
        parent<span class="token operator">:</span> wipFiber<span class="token punctuation">,</span>
        alternate<span class="token operator">:</span> oldFiber<span class="token punctuation">,</span>
        effectTag<span class="token operator">:</span> <span class="token string">&quot;UPDATE&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ele <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sameType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// add this node</span>
      newFiber <span class="token operator">=</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> element<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
        props<span class="token operator">:</span> element<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
        dom<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        parent<span class="token operator">:</span> wipFiber<span class="token punctuation">,</span>
        alternate<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        effectTag<span class="token operator">:</span> <span class="token string">&quot;PLACEMENT&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sameType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// delete the oldFiber's node</span>
      oldFiber<span class="token punctuation">.</span>effectTag <span class="token operator">=</span> <span class="token string">&quot;DELETION&quot;</span>
      deletions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>oldFiber<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      wipFiber<span class="token punctuation">.</span>child <span class="token operator">=</span> newFiber
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      prevSibling<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber
    <span class="token punctuation">}</span>
â€‹
    prevSibling <span class="token operator">=</span> newFiber
    index<span class="token operator">++</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="function-components"><a href="#function-components" class="header-anchor">#</a> Function Components</h3> <p>æ¥ä¸‹æ¥éœ€è¦å¢åŠ å¯¹å‡½æ•°å¼ç»„ä»¶çš„æ”¯æŒ</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isFunctionComponent <span class="token operator">=</span>
    fiber<span class="token punctuation">.</span>type <span class="token keyword">instanceof</span> <span class="token class-name">Function</span>

  <span class="token comment">// å‡½æ•°å¼ç»„ä»¶è¿›è¡Œä¸“é—¨çš„å‡½æ•°æ›´æ–°</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isFunctionComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">updateHostComponent</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span>
    <span class="token comment">// updateHostComponent å†…å®¹å³ä¸€ä¸‹éƒ¨åˆ†ï¼š</span>
    <span class="token comment">// if (!fiber.dom) {</span>
    <span class="token comment">//   fiber.dom = createDom(fiber)</span>
    <span class="token comment">// }</span>
    <span class="token comment">// const elements = fiber.props.children</span>
    <span class="token comment">// reconcileChildren(fiber, elements)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fiber<span class="token punctuation">.</span>child
  <span class="token punctuation">}</span>
  
  <span class="token keyword">let</span> nextFiber <span class="token operator">=</span> fiber
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> nextFiber<span class="token punctuation">.</span>sibling
    <span class="token punctuation">}</span>
    nextFiber <span class="token operator">=</span> nextFiber<span class="token punctuation">.</span>parent
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token punctuation">[</span>fiber<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> children<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> domParentFiber <span class="token operator">=</span> fiber<span class="token punctuation">.</span>parent

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>domParentFiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    domParentFiber <span class="token operator">=</span> domParentFiber<span class="token punctuation">.</span>parent
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> domParent <span class="token operator">=</span> domParentFiber<span class="token punctuation">.</span>dom

  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    fiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">&quot;PLACEMENT&quot;</span> <span class="token operator">&amp;&amp;</span>
    fiber<span class="token punctuation">.</span>dom <span class="token operator">!=</span> <span class="token keyword">null</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    domParent<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
    fiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">&quot;UPDATE&quot;</span> <span class="token operator">&amp;&amp;</span>
    fiber<span class="token punctuation">.</span>dom <span class="token operator">!=</span> <span class="token keyword">null</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">updateDom</span><span class="token punctuation">(</span>
      fiber<span class="token punctuation">.</span>dom<span class="token punctuation">,</span>
      fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
      fiber<span class="token punctuation">.</span>props
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">&quot;DELETION&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">commitDeletion</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> domParent<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
â€‹
  <span class="token function">commitWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// æ›´æ”¹ä¸ºæ‰¾åˆ°æ‹¥æœ‰ dom èŠ‚ç‚¹çš„ fiber ä¸ºæ­¢</span>
<span class="token keyword">function</span> <span class="token function">commitDeletion</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> domParent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    domParent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">commitDeletion</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">,</span> domParent<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="hooks"><a href="#hooks" class="header-anchor">#</a> Hooks</h3> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">/** @jsx Didact.createElement */</span>
<span class="token keyword">function</span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> Didact<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      Count: </span><span class="token punctuation">{</span>state<span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Counter</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> wipFiber <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">let</span> hookIndex <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  wipFiber <span class="token operator">=</span> fiber
  hookIndex <span class="token operator">=</span> <span class="token number">0</span>
  wipFiber<span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token punctuation">[</span>fiber<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> children<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initial</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> oldHook <span class="token operator">=</span>
    wipFiber<span class="token punctuation">.</span>alternate <span class="token operator">&amp;&amp;</span>
    wipFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>hooks <span class="token operator">&amp;&amp;</span>
    wipFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>hooks<span class="token punctuation">[</span>hookIndex<span class="token punctuation">]</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token punctuation">{</span>
    state<span class="token operator">:</span> oldHook <span class="token operator">?</span> oldHook<span class="token punctuation">.</span>state <span class="token operator">:</span> initial<span class="token punctuation">,</span>
    queue<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
â€‹
  <span class="token keyword">const</span> actions <span class="token operator">=</span> oldHook <span class="token operator">?</span> oldHook<span class="token punctuation">.</span>queue <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  actions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    hook<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token function">action</span><span class="token punctuation">(</span>hook<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> <span class="token function-variable function">setState</span> <span class="token operator">=</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
    wipRoot <span class="token operator">=</span> <span class="token punctuation">{</span>
      dom<span class="token operator">:</span> currentRoot<span class="token punctuation">.</span>dom<span class="token punctuation">,</span>
      props<span class="token operator">:</span> currentRoot<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
      alternate<span class="token operator">:</span> currentRoot<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è®¾ç½®ä¸ºä¸‹ä¸€ä¸ªæ›´æ–°å·¥ä½œå•å…ƒ</span>
    nextUnitOfWork <span class="token operator">=</span> wipRoot
    deletions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  wipFiber<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span>
  hookIndex<span class="token operator">++</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">æœ€åæ›´æ–°æ—¶é—´:</span> <span class="time">7/5/2022, 3:45:23 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/notebook/react/setup.html" class="prev">
        react
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/notebook/assets/js/app.15aa8661.js" defer></script><script src="/notebook/assets/js/2.b500958f.js" defer></script><script src="/notebook/assets/js/31.966a99c6.js" defer></script>
  </body>
</html>
