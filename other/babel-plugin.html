<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>《babel 插件通关秘籍》笔记 | theydy</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/notebook/icon.png">
    <meta name="description" content="读书笔记 + 知识整理">
    
    <link rel="preload" href="/notebook/assets/css/0.styles.254e6a27.css" as="style"><link rel="preload" href="/notebook/assets/js/app.f93a82ca.js" as="script"><link rel="preload" href="/notebook/assets/js/2.b500958f.js" as="script"><link rel="preload" href="/notebook/assets/js/6.c225936f.js" as="script"><link rel="prefetch" href="/notebook/assets/js/10.9b9fb949.js"><link rel="prefetch" href="/notebook/assets/js/11.0c53d4d0.js"><link rel="prefetch" href="/notebook/assets/js/12.7337bf74.js"><link rel="prefetch" href="/notebook/assets/js/13.a12941b3.js"><link rel="prefetch" href="/notebook/assets/js/14.fe619aac.js"><link rel="prefetch" href="/notebook/assets/js/15.36202047.js"><link rel="prefetch" href="/notebook/assets/js/16.5b5fa4cf.js"><link rel="prefetch" href="/notebook/assets/js/17.7f50f2ba.js"><link rel="prefetch" href="/notebook/assets/js/18.c04dfad2.js"><link rel="prefetch" href="/notebook/assets/js/19.63e100a0.js"><link rel="prefetch" href="/notebook/assets/js/20.9e714044.js"><link rel="prefetch" href="/notebook/assets/js/21.d1dde936.js"><link rel="prefetch" href="/notebook/assets/js/22.d794a2f8.js"><link rel="prefetch" href="/notebook/assets/js/23.ee623710.js"><link rel="prefetch" href="/notebook/assets/js/24.a0e8eeb4.js"><link rel="prefetch" href="/notebook/assets/js/25.11734ba0.js"><link rel="prefetch" href="/notebook/assets/js/26.443dcf69.js"><link rel="prefetch" href="/notebook/assets/js/27.e5356ba8.js"><link rel="prefetch" href="/notebook/assets/js/28.b2d5c99f.js"><link rel="prefetch" href="/notebook/assets/js/29.f7ae4896.js"><link rel="prefetch" href="/notebook/assets/js/3.2af46054.js"><link rel="prefetch" href="/notebook/assets/js/4.779e3c9b.js"><link rel="prefetch" href="/notebook/assets/js/5.5b45f7ce.js"><link rel="prefetch" href="/notebook/assets/js/7.22950914.js"><link rel="prefetch" href="/notebook/assets/js/8.edafac0c.js"><link rel="prefetch" href="/notebook/assets/js/9.3738fea4.js">
    <link rel="stylesheet" href="/notebook/assets/css/0.styles.254e6a27.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notebook/" class="home-link router-link-active"><!----> <span class="site-name">theydy</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/notebook/interview/js.html" class="nav-link">
  前端面试
</a></div><div class="nav-item"><a href="/notebook/vue/analysis.html" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/notebook/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/notebook/webpack/" class="nav-link">
  Webpack
</a></div><div class="nav-item"><a href="/notebook/other/tools.html" class="nav-link">
  杂七杂八
</a></div> <a href="https://github.com/theydy/notebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/notebook/interview/js.html" class="nav-link">
  前端面试
</a></div><div class="nav-item"><a href="/notebook/vue/analysis.html" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/notebook/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/notebook/webpack/" class="nav-link">
  Webpack
</a></div><div class="nav-item"><a href="/notebook/other/tools.html" class="nav-link">
  杂七杂八
</a></div> <a href="https://github.com/theydy/notebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>杂七杂八</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notebook/other/tools.html" class="sidebar-link">常用工具</a></li><li><a href="/notebook/other/git.html" class="sidebar-link">Git</a></li><li><a href="/notebook/other/node.html" class="sidebar-link">node</a></li><li><a href="/notebook/other/typescript.html" class="sidebar-link">typescript</a></li><li><a href="/notebook/other/snippets.html" class="sidebar-link">snippets</a></li><li><a href="/notebook/other/babel-plugin.html" aria-current="page" class="active sidebar-link">《babel 插件通关秘籍》笔记</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notebook/other/babel-plugin.html#parse" class="sidebar-link">parse</a></li><li class="sidebar-sub-header"><a href="/notebook/other/babel-plugin.html#transform" class="sidebar-link">transform</a></li><li class="sidebar-sub-header"><a href="/notebook/other/babel-plugin.html#generate" class="sidebar-link">generate</a></li><li class="sidebar-sub-header"><a href="/notebook/other/babel-plugin.html#ast" class="sidebar-link">AST</a></li><li class="sidebar-sub-header"><a href="/notebook/other/babel-plugin.html#babel-的-api" class="sidebar-link">babel 的 api</a></li><li class="sidebar-sub-header"><a href="/notebook/other/babel-plugin.html#🌰1" class="sidebar-link">🌰1</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="《babel-插件通关秘籍》笔记"><a href="#《babel-插件通关秘籍》笔记" class="header-anchor">#</a> 《babel 插件通关秘籍》笔记</h1> <p>babel 是一个转译器，分为 <code>parse</code>、<code>transform</code>、<code>generate</code> 三步。</p> <h2 id="parse"><a href="#parse" class="header-anchor">#</a> parse</h2> <p>parse 阶段的目的是把源码字符串转换成机器能够理解的 AST，这个过程分为词法分析、语法分析。</p> <p>比如 <code>let name = 'guang';</code> 这样一段源码，我们要先把它分成一个个不能细分的单词（token），也就是 <code>let</code>, <code>name</code>, <code>=</code>, <code>'guang'</code>，这个过程是词法分析，按照单词的构成规则来拆分字符串成单词。</p> <p>之后要把 token 进行递归的组装，生成 AST，这个过程是语法分析，按照不同的语法结构，来把一组单词组合成对象。</p> <div style="text-align:center;"><img src="/notebook/assets/img/babel-plugin-1.f2cac668.png"></div> <h2 id="transform"><a href="#transform" class="header-anchor">#</a> transform</h2> <p>transform 阶段是对 parse 生成的 AST 的处理，会进行 AST 的遍历，遍历的过程中处理到不同的 AST 节点会调用注册的相应的 visitor 函数，visitor 函数里可以对 AST 节点进行增删改，返回新的 AST。这样遍历完一遍 AST 之后就完成了对代码的修改。</p> <h2 id="generate"><a href="#generate" class="header-anchor">#</a> generate</h2> <p>generate 阶段会把 AST 打印成目标代码字符串。</p> <h2 id="ast"><a href="#ast" class="header-anchor">#</a> AST</h2> <p>抽象语法树</p> <p><a href="https://astexplorer.net/" target="_blank" rel="noopener noreferrer">https://astexplorer.net/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>常见 AST 节点</p> <ul><li><code>Literal</code>：Literal 是字面量的意思，比如 <code>let name = 'guang'</code> 中，<code>'guang'</code> 就是一个字符串字面量 <code>StringLiteral</code>，相应的还有数字字面量 <code>NumericLiteral</code>，布尔字面量 <code>BooleanLiteral</code>，正则表达式字面量 <code>RegExpLiteral</code> 等</li> <li><code>Identifier</code>：Identifer 是标识符的意思，变量名、属性名、参数名等各种声明和引用的名字，都是Identifer，Identifier 是变量和变量的引用。例如：const name = 'guang'、function say(name) { console.log(name) }、const obj = { name: 'guang' } 中红色部分都是 Identifier。</li> <li><code>Statement</code>：Statement 是语句，它是可以独立执行的单位，比如 break、continue、debugger、return 或者 if 语句、while 语句、for 语句，还有声明语句，表达式语句等。我们写的每一条可以独立执行的代码都是语句。语句是代码执行的最小单位，可以说，代码是由语句（Statement）构成的。</li> <li><code>Declaration</code>：Declaration 声明语句是一种特殊的语句，它执行的逻辑是在作用域内声明一个变量、函数、class、import、export 等。</li> <li><code>Expression</code>：Expression 是表达式，特点是执行完以后有返回值，这是和语句 (statement) 的区别。表达式的特点是有返回值，有的表达式可以独立作为语句执行，会包裹一层 ExpressionStatement。</li> <li><code>File &amp; Comment &amp; Program &amp; Directive</code>：babel 的 AST 最外层节点是 File，它有 program、comments、tokens 等属性，分别存放 Program 程序体、注释、token 等，是最外层节点。<code>&quot;use strict&quot;</code> 这种指令会使用 Directive 节点表示</li></ul> <p>AST 公共属性</p> <ul><li><code>type</code>：AST 节点类型</li> <li><code>start、end、loc</code>：start 和 end 代表该节点对应的源码字符串的开始和结束下标，不区分行列。而 loc 属性是一个对象，有 line 和 column 属性分别记录开始和结束行列号。</li> <li><code>leadingComments、innerComments、trailingComments</code>： 表示开始的注释、中间的注释、结尾的注释，因为每个 AST 节点中都可能存在注释，而且可能在开始、中间、结束这三种位置，通过这三个属性来记录和 Comment 的关联。</li> <li><code>extra</code>：记录一些额外的信息，用于处理一些特殊情况。</li></ul> <h2 id="babel-的-api"><a href="#babel-的-api" class="header-anchor">#</a> babel 的 api</h2> <p>babel 针对不同的步骤封装了不同的 npm 包，parse 阶段使用 <code>@babel/parser</code>；transform 阶段使用 <code>@babel/traverse</code>、<code>@babel/types</code>、<code>@babel/template</code>；generate 阶段使用 <code>@babel/generate</code>。</p> <h3 id="babel-parser"><a href="#babel-parser" class="header-anchor">#</a> @babel/parser</h3> <p>文档：</p> <p><a href="https://babeljs.io/docs/en/babel-parser#api" target="_blank" rel="noopener noreferrer">https://babeljs.io/docs/en/babel-parser#api<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>主要提供了两个 api，<code>parse</code> 和 <code>parseExpression</code>。</p> <p>两者都是把源码转成 AST，不过 parse 返回的 AST 根节点是 File（整个 AST），parseExpression 返回的 AST 根节点是是 Expression（表达式的 AST），粒度不同。</p> <p>这两个 api 接收的参数相同，第一个参数是需要转译的字符串，第二个参数是转译的配置 options。</p> <p>options 内的配置主要分为两类：</p> <ul><li>parse 的内容：
<ul><li><code>plugins</code>：指定是 jsx、typescript、flow 等插件类解析对应的语法</li> <li><code>allowXxx</code>：指定一些语法是否允许</li> <li><code>sourceType</code>：指定是否支持解析模块语法，有 module、script、unambiguous 3个取值，module 是解析 es module 语法，script 则不解析 es module 语法，当作脚本执行，unambiguous 则是根据内容是否有 import 和 export 来确定是否解析 es module 语法。</li></ul></li> <li>parse 的方式：
<ul><li><code>strictMode</code>：是否是严格模式</li> <li><code>startLine</code>：从源码哪一行开始 parse</li> <li><code>errorRecovery</code>：出错时是否记录错误并继续往下 parse</li> <li><code>tokens</code>：parse 的时候是否保留 token 信息</li> <li><code>ranges</code>：是否在 ast 节点中添加 ranges 属性</li></ul></li></ul> <p>举个🌰：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/parser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  sourceType<span class="token operator">:</span> <span class="token string">&quot;module&quot;</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;jsx&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;typescript&quot;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="babel-traverse"><a href="#babel-traverse" class="header-anchor">#</a> @babel/traverse</h3> <p>文档：</p> <p><a href="https://babeljs.io/docs/en/babel-traverse" target="_blank" rel="noopener noreferrer">https://babeljs.io/docs/en/babel-traverse<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>只提供了一个 api：<code>function traverse(ast, opts)</code>，ast 为指定要遍历的 AST 节点，opts 指定针对不同 ast 类型节点的 visitor 函数或对象。</p> <p>举个🌰：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token string">'FunctionDeclaration|VariableDeclaration'</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 函数写法默认是 enter</span>
  StringLiteral<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">enter</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 进入节点后调用</span>
    <span class="token function">exit</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 离开节点前调用</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>可以看到，visitor 可以是一个对象或函数，接收两个参数：path、state。</p> <ul><li><p>path：遍历过程中的路径，会保留上下文信息，有很多属性和方法</p> <ul><li>path.node 指向当前 AST 节点</li> <li>path.get、path.set 获取和设置当前节点属性的 path</li> <li>path.parent 指向父级 AST 节点</li> <li>path.findParent 查找是否有某个父节点</li> <li>path.getSibling、path.getNextSibling、path.getPrevSibling 获取兄弟节点</li> <li>path.scope 获取当前节点的作用域信息</li> <li>path.isXxx 判断当前节点是不是 xx 类型</li> <li>path.assertXxx 判断当前节点是不是 xx 类型，不是则抛出异常</li> <li>path.insertBefore、path.insertAfter 插入节点</li> <li>path.replaceWith、path.replaceWithMultiple、replaceWithSourceString 替换节点</li> <li>path.remove 删除节点</li> <li>path.skip 跳过当前节点的子节点的遍历</li> <li>path.stop 结束后续遍历</li></ul> <div style="text-align:center;"><img src="/notebook/assets/img/babel-plugin-2.ec1fd302.png"></div></li> <li><p>state：遍历过程中在不同节点之间传递数据的机制，插件会通过 state 传递 options 和 file 信息，我们也可以通过 state 存储一些遍历过程中的共享数据。</p></li></ul> <h3 id="babel-types"><a href="#babel-types" class="header-anchor">#</a> @babel/types</h3> <p>文档：</p> <p><a href="https://babeljs.io/docs/en/babel-types#api" target="_blank" rel="noopener noreferrer">https://babeljs.io/docs/en/babel-types#api<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>用于遍历 AST 的过程中需要创建一些 AST 和判断 AST 的类型。</p> <h3 id="babel-template"><a href="#babel-template" class="header-anchor">#</a> @babel/template</h3> <p>文档：</p> <p><a href="https://babeljs.io/docs/en/babel-template" target="_blank" rel="noopener noreferrer">https://babeljs.io/docs/en/babel-template<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>通过 @babel/types 创建 AST 还是比较麻烦的，要一个个的创建然后组装，如果 AST 节点比较多的话需要写很多代码，这时候就可以使用 @babel/template 包来批量创建。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">[</span>opts<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ast <span class="token operator">=</span> template<span class="token punctuation">.</span><span class="token function">ast</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">[</span>opts<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ast <span class="token operator">=</span> template<span class="token punctuation">.</span><span class="token function">program</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">[</span>opts<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ast <span class="token operator">=</span> template<span class="token punctuation">.</span><span class="token function">expression</span><span class="token punctuation">(</span><span class="token string">'console.log(&quot;xxx&quot;)'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>opts<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果是根据模版直接创建 AST，那么用 template.ast 或者 template.program 方法，这俩都是直接返回 ast 的，但是 template.program 返回的 AST 的根节点是 Program。</p> <p>如果知道具体创建的 AST 的类型，可以使用 template.expression、template.statement、template.statements 等方法，当明确创建的AST的类型时可以使用。</p> <p>默认 template.ast 创建的 Expression 会被包裹一层 ExpressionStatement 节点（会被当成表达式语句来 parse），但当 template.expression 方法创建的 AST 就不会。</p> <p>如果模版中有占位符，那么就用 template 的 api，在模版中写一些占位的参数，调用时传入这些占位符参数对应的 AST 节点。</p> <h3 id="babel-generator"><a href="#babel-generator" class="header-anchor">#</a> @babel/generator</h3> <p>文档：</p> <p><a href="https://babeljs.io/docs/en/babel-generator" target="_blank" rel="noopener noreferrer">https://babeljs.io/docs/en/babel-generator<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>将 AST 转换为目标代码字符串。只提供了一个 api：<code>function generate(ast, opts, code)</code>，ast 为指定要转换的 AST。opts 指定打印的一些细节，比如通过 comments 指定是否包含注释，通过 minified 指定是否包含空白字符。第三个参数当多个文件合并打印的时候需要用到。</p> <p>options 中常用的是 sourceMaps，开启了这个选项才会生成 sourcemap</p> <h2 id="🌰1"><a href="#🌰1" class="header-anchor">#</a> 🌰1</h2> <blockquote><p>希望通过 babel 能够自动在 console.log 等 api 中插入文件名和行列号的参数，方便定位到代码。</p></blockquote> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/traverse'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
<span class="token keyword">const</span> generator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/generator'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
<span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/types'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/template'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>

<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  let a = 1;
  const f = () =&gt; { 
    console.info(a) 
  };
  console.log('error 1', a);
  f();
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ast <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    sourceType<span class="token operator">:</span> <span class="token string">'unambiguous'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">CallExpression</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> node <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">;</span>
        <span class="token keyword">const</span> callee <span class="token operator">=</span> node<span class="token punctuation">.</span>callee<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>isNew<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
            t<span class="token punctuation">.</span><span class="token function">isMemberExpression</span><span class="token punctuation">(</span>callee<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            callee<span class="token punctuation">.</span>object<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'console'</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span> line<span class="token punctuation">,</span> column <span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>start<span class="token punctuation">;</span>
            <span class="token keyword">const</span> newnode <span class="token operator">=</span> template<span class="token punctuation">.</span><span class="token function">expression</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">console.log(&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>line<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>column<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            newnode<span class="token punctuation">.</span>isNew <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            path<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>newnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> newCode <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newCode<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>改写成插件的形式</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// my-plugin.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">api<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> types<span class="token operator">:</span> t<span class="token punctuation">,</span> template <span class="token punctuation">}</span> <span class="token operator">=</span> api<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    visitor<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">CallExpression</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> node <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">;</span>
        <span class="token keyword">const</span> callee <span class="token operator">=</span> node<span class="token punctuation">.</span>callee<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>isNew<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          t<span class="token punctuation">.</span><span class="token function">isMemberExpression</span><span class="token punctuation">(</span>callee<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          callee<span class="token punctuation">.</span>object<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'console'</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> <span class="token punctuation">{</span> line<span class="token punctuation">,</span> column <span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>start<span class="token punctuation">;</span>
          <span class="token keyword">const</span> newnode <span class="token operator">=</span> template<span class="token punctuation">.</span><span class="token function">expression</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">console.log(&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>line<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>column<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          newnode<span class="token punctuation">.</span>isNew <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          path<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>newnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用</span>
<span class="token keyword">const</span> myPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'my-plugin.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> transformFromAstSync <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/core'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ast <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>sourceCode<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    sourceType<span class="token operator">:</span> <span class="token string">'unambiguous'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">transformFromAstSync</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> sourceCode<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span>myPlugin<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">10/14/2021, 12:16:53 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/notebook/other/snippets.html" class="prev">
        snippets
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/notebook/assets/js/app.f93a82ca.js" defer></script><script src="/notebook/assets/js/2.b500958f.js" defer></script><script src="/notebook/assets/js/6.c225936f.js" defer></script>
  </body>
</html>
