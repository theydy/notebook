<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>webpack | theydy</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/notebook/icon.png">
    <meta name="description" content="读书笔记 + 知识整理">
    
    <link rel="preload" href="/notebook/assets/css/0.styles.254e6a27.css" as="style"><link rel="preload" href="/notebook/assets/js/app.712c0964.js" as="script"><link rel="preload" href="/notebook/assets/js/2.b500958f.js" as="script"><link rel="preload" href="/notebook/assets/js/22.aa6ea6e6.js" as="script"><link rel="prefetch" href="/notebook/assets/js/10.72f94101.js"><link rel="prefetch" href="/notebook/assets/js/11.4e057ea8.js"><link rel="prefetch" href="/notebook/assets/js/12.96ace62a.js"><link rel="prefetch" href="/notebook/assets/js/13.564cae12.js"><link rel="prefetch" href="/notebook/assets/js/14.3eaa783e.js"><link rel="prefetch" href="/notebook/assets/js/15.38a0017d.js"><link rel="prefetch" href="/notebook/assets/js/16.239ebd34.js"><link rel="prefetch" href="/notebook/assets/js/17.ae11984e.js"><link rel="prefetch" href="/notebook/assets/js/18.4f83f6eb.js"><link rel="prefetch" href="/notebook/assets/js/19.25a93ba9.js"><link rel="prefetch" href="/notebook/assets/js/20.a40d1dd2.js"><link rel="prefetch" href="/notebook/assets/js/21.4fae332a.js"><link rel="prefetch" href="/notebook/assets/js/23.18d00419.js"><link rel="prefetch" href="/notebook/assets/js/24.8676fad5.js"><link rel="prefetch" href="/notebook/assets/js/25.cdd52113.js"><link rel="prefetch" href="/notebook/assets/js/26.a4e1407a.js"><link rel="prefetch" href="/notebook/assets/js/27.5ea7889c.js"><link rel="prefetch" href="/notebook/assets/js/28.4f452941.js"><link rel="prefetch" href="/notebook/assets/js/29.4445e879.js"><link rel="prefetch" href="/notebook/assets/js/3.6e482d8e.js"><link rel="prefetch" href="/notebook/assets/js/30.5dbfe8c9.js"><link rel="prefetch" href="/notebook/assets/js/31.966a99c6.js"><link rel="prefetch" href="/notebook/assets/js/32.65399fb3.js"><link rel="prefetch" href="/notebook/assets/js/33.517cd9f7.js"><link rel="prefetch" href="/notebook/assets/js/34.7650cb4f.js"><link rel="prefetch" href="/notebook/assets/js/35.8cb6535a.js"><link rel="prefetch" href="/notebook/assets/js/36.e4cea6a9.js"><link rel="prefetch" href="/notebook/assets/js/37.65ab33d6.js"><link rel="prefetch" href="/notebook/assets/js/38.f8d83db7.js"><link rel="prefetch" href="/notebook/assets/js/4.779e3c9b.js"><link rel="prefetch" href="/notebook/assets/js/5.5b45f7ce.js"><link rel="prefetch" href="/notebook/assets/js/6.b7898e81.js"><link rel="prefetch" href="/notebook/assets/js/7.22950914.js"><link rel="prefetch" href="/notebook/assets/js/8.edafac0c.js"><link rel="prefetch" href="/notebook/assets/js/9.53cbda99.js">
    <link rel="stylesheet" href="/notebook/assets/css/0.styles.254e6a27.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notebook/" class="home-link router-link-active"><!----> <span class="site-name">theydy</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/notebook/interview/js.html" class="nav-link">
  前端面试
</a></div><div class="nav-item"><a href="/notebook/vue/analysis.html" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/notebook/react/setup.html" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/notebook/webpack/4.html" class="nav-link">
  Webpack
</a></div><div class="nav-item"><a href="/notebook/other/tools.html" class="nav-link">
  杂七杂八
</a></div><div class="nav-item"><a href="/notebook/engineering/package-json.html" class="nav-link">
  工程化
</a></div> <a href="https://github.com/theydy/notebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/notebook/interview/js.html" class="nav-link">
  前端面试
</a></div><div class="nav-item"><a href="/notebook/vue/analysis.html" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/notebook/react/setup.html" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/notebook/webpack/4.html" class="nav-link">
  Webpack
</a></div><div class="nav-item"><a href="/notebook/other/tools.html" class="nav-link">
  杂七杂八
</a></div><div class="nav-item"><a href="/notebook/engineering/package-json.html" class="nav-link">
  工程化
</a></div> <a href="https://github.com/theydy/notebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前端面试</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notebook/interview/js.html" class="sidebar-link">javascript 基础</a></li><li><a href="/notebook/interview/css.html" class="sidebar-link">css</a></li><li><a href="/notebook/interview/code.html" class="sidebar-link">各种手写题</a></li><li><a href="/notebook/interview/browser.html" class="sidebar-link">浏览器相关</a></li><li><a href="/notebook/interview/http.html" class="sidebar-link">HTTP 相关</a></li><li><a href="/notebook/interview/vue.html" class="sidebar-link">vue 面试题</a></li><li><a href="/notebook/interview/react.html" class="sidebar-link">react 面试题</a></li><li><a href="/notebook/interview/safety.html" class="sidebar-link">前端安全</a></li><li><a href="/notebook/interview/webpack.html" aria-current="page" class="active sidebar-link">webpack</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notebook/interview/webpack.html#webpack-执行流程" class="sidebar-link">webpack 执行流程</a></li><li class="sidebar-sub-header"><a href="/notebook/interview/webpack.html#常用的钩子" class="sidebar-link">常用的钩子</a></li><li class="sidebar-sub-header"><a href="/notebook/interview/webpack.html#loader" class="sidebar-link">loader</a></li><li class="sidebar-sub-header"><a href="/notebook/interview/webpack.html#plugin" class="sidebar-link">plugin</a></li><li class="sidebar-sub-header"><a href="/notebook/interview/webpack.html#优化手段" class="sidebar-link">优化手段</a></li><li class="sidebar-sub-header"><a href="/notebook/interview/webpack.html#hmr-热更新原理" class="sidebar-link">HMR 热更新原理</a></li><li class="sidebar-sub-header"><a href="/notebook/interview/webpack.html#tree-shaking-原理" class="sidebar-link">tree shaking 原理</a></li></ul></li><li><a href="/notebook/interview/optimization.html" class="sidebar-link">性能优化</a></li><li><a href="/notebook/interview/algorithm.html" class="sidebar-link">算法</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="webpack"><a href="#webpack" class="header-anchor">#</a> webpack</h1> <h2 id="webpack-执行流程"><a href="#webpack-执行流程" class="header-anchor">#</a> webpack 执行流程</h2> <p>webpack 的构建流程。</p> <p>首先解析 config 和 shell 中的配置项，合并生成 options</p> <p>然后调用 webpack 函数，返回 compiler 对象，实例化 compiler 对象后会初始化 webpack 内置的插件和 options 配置，并将它们挂载在 compiler 对象上，compiler 相当于一个全局的执行上下文，上面记录了完整的 webpack 环境信息，一个 webpack 进程中，只会生成一次 compiler</p> <p><strong>执行 compiler 的 run 方法开始编译</strong>，首先构建 compilation 对象，这个对象负责组织整个编译过程，对象上包含每个构建环节对应的方法，还保存着 modules，chunks，生成的 assets 以及最后生成 js 的 template，每次编译都会生成一个新的 compilation</p> <p><strong>在 make 钩子中执行 compilation 的 addEntry 方法</strong>，addEntry 中又调用 _addModuleChain 开始构建模块</p> <p>构建模块首先执行相应的 loader 对读取的源文件进行处理，然后转成 ast，遍历 ast 找到所有的依赖模块，接着递归构建所有的依赖模块。</p> <p><strong>执行 compilation 的 seal 方法</strong>，这个方法主要调用各插件对构建后的结果进行封装和修改。</p> <p>最后调用 <strong>compiler.emitAssets</strong> 按照 output 中的配置输出文件。</p> <h2 id="常用的钩子"><a href="#常用的钩子" class="header-anchor">#</a> 常用的钩子</h2> <p><strong>compiler：</strong></p> <ul><li>run</li> <li>compile</li> <li>make</li> <li>emit</li> <li>done</li></ul> <p><strong>compilation：</strong></p> <ul><li>buildModule</li> <li>seal</li> <li>optimize</li></ul> <h2 id="loader"><a href="#loader" class="header-anchor">#</a> loader</h2> <p>就是一个函数，接受「源文件文件内容」做为参数</p> <h2 id="plugin"><a href="#plugin" class="header-anchor">#</a> plugin</h2> <p>一个类，需要实现 apply 方法，apply 方法接受「compiler」做为参数</p> <h2 id="优化手段"><a href="#优化手段" class="header-anchor">#</a> 优化手段</h2> <h3 id="module-优化配置"><a href="#module-优化配置" class="header-anchor">#</a> module 优化配置</h3> <ul><li>noParse：去除不需要 webpack 处理的文件</li> <li>rules：test、include、exclude 配置范围内需要处理的文件</li></ul> <h3 id="resolve-优化配置"><a href="#resolve-优化配置" class="header-anchor">#</a> resolve 优化配置</h3> <ul><li>alias：路径别名</li> <li>extensions：导入文件后缀优先级</li></ul> <h3 id="相关优化-loader-plugin"><a href="#相关优化-loader-plugin" class="header-anchor">#</a> 相关优化 loader plugin</h3> <ul><li>ThreadLoader：多进程处理 loader</li> <li>MiniCssExtractPlugin：提取 css</li> <li>OptimizeCssAssetsWebpackPlugin：压缩 css，optimization.minimizer</li> <li>TerserWebpackPlugin：多进程压缩 js，optimization.minimizer</li></ul> <h3 id="splitchunks-代码分割"><a href="#splitchunks-代码分割" class="header-anchor">#</a> splitChunks 代码分割</h3> <p>主要是 optimization.splitChunks.cacheGroups 配置</p> <h2 id="hmr-热更新原理"><a href="#hmr-热更新原理" class="header-anchor">#</a> HMR 热更新原理</h2> <p>服务端和客户端会建立 websocket 连接，当 webpack 监听到文件被修改，触发了重新编译，编译完成后在 done 钩子中通过 websocket 向客户端推动当前编译的 hash，如果客户端比较 hash 不一致，就会通过 ajax 和 jsonp 向服务端获取最新的资源完成替换。</p> <p>所以一般来说 webpack-dev-server 和 HMR 要配对使用，否则会无效，如果使用了 webpack-dev-middleware 而没有使用 webpack-dev-server，请使用 webpack-hot-middleware 依赖包开启 HMR。</p> <h2 id="tree-shaking-原理"><a href="#tree-shaking-原理" class="header-anchor">#</a> tree shaking 原理</h2> <p>tree shaking 是 webpack 的一项功能，tree shaking 只能在 ESModule 中使用，如果先通过 babel 转为 CommonJS 就用不了。</p> <p>ES6 模块依赖关系是确定的，和运行时的状态无关，可以进行可靠的静态分析，在编译阶段分析出引入但是没用的模块，不打包到 boundle 里。</p> <p>要使用这项技术，只能使用 webpack 的模块处理，加上 babel 的 es6 转换能力（需要关闭模块转换）。</p> <p>大部分第三方包默认是 commonjs 的模块格式，所以需要而外处理才能使 tree shaking 生效，首先需要第三方包有导出 ES Module 的代码</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;lib/index.js&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 指明采用 CommonJS 模块化的代码入口</span>
  <span class="token string">&quot;jsnext:main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;es/index.js&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 指明采用 ES6 模块化的代码入口，需要手动设置 mainFields</span>
  <span class="token string">&quot;module&quot;</span><span class="token operator">:</span> <span class="token string">&quot;es/index.js&quot;</span> <span class="token comment">// 指明采用 ES6 模块化的代码入口，es 方式引入自动使用，无需额外设置</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后配置 webpack 的 resolve，让 webpack 优先去找 jsnext:main 的文件</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  resolve<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 针对 Npm 中的第三方模块优先采用 jsnext:main 中指向的 ES6 模块化语法的文件</span>
    mainFields<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'jsnext:main'</span><span class="token punctuation">,</span> <span class="token string">'browser'</span><span class="token punctuation">,</span> <span class="token string">'main'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>Webpack 4 的话，开启生产环境就会自动启动这个优化功能</strong></p> <p><strong>开发环境下使用 <code>optimization: { usedExports: true, }</code> 开启</strong></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">6/10/2022, 8:00:52 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/notebook/interview/safety.html" class="prev">
        前端安全
      </a></span> <span class="next"><a href="/notebook/interview/optimization.html">
        性能优化
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/notebook/assets/js/app.712c0964.js" defer></script><script src="/notebook/assets/js/2.b500958f.js" defer></script><script src="/notebook/assets/js/22.aa6ea6e6.js" defer></script>
  </body>
</html>
